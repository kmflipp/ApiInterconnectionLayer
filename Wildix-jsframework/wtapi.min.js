JSJAC_HAVEKEYS=!0;JSJAC_NKEYS=16;JSJAC_INACTIVITY=300;JSJAC_ERR_COUNT=10;JSJAC_ALLOW_PLAIN=!0;JSJAC_ALLOW_SCRAM=!1;JSJAC_CHECKINQUEUEINTERVAL=JSJAC_CHECKQUEUEINTERVAL=100;JSJAC_TIMERVAL=2E3;JSJAC_RETRYDELAY=5E3;JSJAC_REGID_TIMEOUT=2E4;JSJACHBC_MAX_HOLD=1;JSJACHBC_MAX_WAIT=300;JSJACHBC_BOSH_VERSION="1.10";JSJACHBC_USE_BOSH_VER=!0;JSJACHBC_MAXPAUSE=120;
String.prototype.htmlEnc=function(){if(!this)return this;var a=this.replace(/&/g,"&amp;"),a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),a=a.replace(/\"/g,"&quot;");return a=a.replace(/\n/g,"<br />")};String.prototype.revertHtmlEnc=function(){if(!this)return this;var a=this.replace(/&amp;/gi,"&"),a=a.replace(/&lt;/gi,"<"),a=a.replace(/&gt;/gi,">"),a=a.replace(/&quot;/gi,'"');return a=a.replace(/<br( )?(\/)?>/gi,"\n")};
Date.jab2date=function(a){var b=new Date(Date.UTC(a.substr(0,4),a.substr(5,2)-1,a.substr(8,2),a.substr(11,2),a.substr(14,2),a.substr(17,2)));if("Z"!=a.substr(a.length-6,1)){var c=new Date;c.setTime(0);c.setUTCHours(a.substr(a.length-5,2));c.setUTCMinutes(a.substr(a.length-2,2));"+"==a.substr(a.length-6,1)?b.setTime(b.getTime()-c.getTime()):"-"==a.substr(a.length-6,1)&&b.setTime(b.getTime()+c.getTime())}return b};Date.hrTime=function(a){return Date.jab2date(a).toLocaleString()};
Date.prototype.jabberDate=function(){var a=function(a){return 10>a?"0"+a:a},b=this.getUTCFullYear()+"-",b=b+(a(this.getUTCMonth()+1)+"-"),b=b+(a(this.getUTCDate())+"T"),b=b+(a(this.getUTCHours())+":"),b=b+(a(this.getUTCMinutes())+":");return b+=a(this.getUTCSeconds())+"Z"};Number.max=function(a,b){return a>b?a:b};Number.min=function(a,b){return a<b?a:b};
window.XDomainRequest&&(window.ieXDRToXHR=function(a){var b=a.XMLHttpRequest;a.XMLHttpRequest=function(){this.onreadystatechange=Object;this.xdr=this.xhr=null;this.readyState=0;this.status="";this.send=this.abort=this.setRequestHeader=this.getAllResponseHeaders=this.getResponseHeader=this.responseText=this.statusText=null;this.isxdr=!1;var a=this;a.xdrLoadedBinded=function(){a.xdrLoaded()};a.xdrErrorBinded=function(){a.xdrError()};a.xdrProgressBinded=function(){a.xdrProgress()};a.xhrReadyStateChangedBinded=
function(){a.xhrReadyStateChanged()}};XMLHttpRequest.prototype.open=function(c,d,e,f,g){var k=document.createElement("a");k.href=d;k.hostname!=document.domain?(null===this.xdr&&(this.xdr=new a.XDomainRequest),this.isxdr=!0,this.setXDRActive(),this.xdr.open(c,d)):(null===this.xhr&&(this.xhr=new b),this.isxdr=!1,this.setXHRActive(),this.xhr.open(c,d,e,f,g))};XMLHttpRequest.prototype.xdrGetResponseHeader=function(a){return"Content-Type"===a&&""<this.xdr.contentType?this.xdr.contentType:""};XMLHttpRequest.prototype.xdrGetAllResponseHeaders=
function(){return""<this.xdr.contentType?"Content-Type: "+this.xdr.contentType:""};XMLHttpRequest.prototype.xdrSetRequestHeader=function(a,b){};XMLHttpRequest.prototype.xdrLoaded=function(){if(null!==this.onreadystatechange){this.readyState=4;this.status=200;this.statusText="OK";this.responseText=this.xdr.responseText;if(a.ActiveXObject){var c=new ActiveXObject("Microsoft.XMLDOM");c.async="false";c.loadXML(this.responseText);this.responseXML=c}this.onreadystatechange()}};XMLHttpRequest.prototype.xdrError=
function(){null!==this.onreadystatechange&&(this.readyState=4,this.status=0,this.responseText=this.statusText="",this.onreadystatechange())};XMLHttpRequest.prototype.xdrProgress=function(){null!==this.onreadystatechange&&3!==this.status&&(this.status=this.readyState=3,this.statusText="",this.onreadystatechange())};XMLHttpRequest.prototype.finalXDRRequest=function(){var a=this.xdr;delete a.onload;delete a.onerror;delete a.onprogress};XMLHttpRequest.prototype.sendXDR=function(a){var b=this.xdr;b.onload=
this.xdrLoadedBinded;b.onerror=this.xdr.ontimeout=this.xdrErrorBinded;b.onprogress=this.xdrProgressBinded;this.responseText=null;this.xdr.send(a)};XMLHttpRequest.prototype.abortXDR=function(){this.finalXDRRequest();this.xdr.abort()};XMLHttpRequest.prototype.setXDRActive=function(){this.send=this.sendXDR;this.abort=this.abortXDR;this.getResponseHeader=this.xdrGetResponseHeader;this.getAllResponseHeaders=this.xdrGetAllResponseHeaders;this.setRequestHeader=this.xdrSetRequestHeader};XMLHttpRequest.prototype.xhrGetResponseHeader=
function(a){return this.xhr.getResponseHeader(a)};XMLHttpRequest.prototype.xhrGetAllResponseHeaders=function(){return this.xhr.getAllResponseHeaders()};XMLHttpRequest.prototype.xhrSetRequestHeader=function(a,b){return this.xhr.setRequestHeader(a,b)};XMLHttpRequest.prototype.xhrReadyStateChanged=function(){if(null!==this.onreadystatechange&&this.readyState!==this.xhr.readyState){var a=this.xhr;this.readyState=a.readyState;4===this.readyState&&(this.status=a.status,this.statusText=a.statusText,this.responseText=
a.responseText,this.responseXML=a.responseXML,this.responseBody=a.responseBody);this.onreadystatechange()}};XMLHttpRequest.prototype.finalXHRRequest=function(){delete this.xhr.onreadystatechange};XMLHttpRequest.prototype.abortXHR=function(){this.finalXHRRequest();this.xhr.abort()};XMLHttpRequest.prototype.sendXHR=function(a){this.xhr.onreadystatechange=this.xhrReadyStateChangedBinded;this.xhr.send(a)};XMLHttpRequest.prototype.setXHRActive=function(){this.send=this.sendXHR;this.abort=this.abortXHR;
this.getResponseHeader=this.xhrGetResponseHeader;this.getAllResponseHeaders=this.xhrGetAllResponseHeaders;this.setRequestHeader=this.xhrSetRequestHeader};a.ieXDRToXHR=void 0},window.ieXDRToXHR(window));var hexcase=0,b64pad="=";function hex_sha1(a){return rstr2hex(rstr_sha1(str2rstr_utf8(a)))}function b64_sha1(a){return rstr2b64(rstr_sha1(str2rstr_utf8(a)))}function any_sha1(a,b){return rstr2any(rstr_sha1(str2rstr_utf8(a)),b)}
function hex_hmac_sha1(a,b){return rstr2hex(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(b)))}function b64_hmac_sha1(a,b){return rstr2b64(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(b)))}function any_hmac_sha1(a,b,c){return rstr2any(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(b)),c)}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc").toLowerCase()}function rstr_sha1(a){return binb2rstr(binb_sha1(rstr2binb(a),8*a.length))}
function rstr_hmac_sha1(a,b){var c=rstr2binb(a);16<c.length&&(c=binb_sha1(c,8*a.length));for(var d=Array(16),e=Array(16),f=0;16>f;f++)d[f]=c[f]^909522486,e[f]=c[f]^1549556828;c=binb_sha1(d.concat(rstr2binb(b)),512+8*b.length);return binb2rstr(binb_sha1(e.concat(c),672))}function rstr2binb(a){for(var b=Array(a.length>>2),c=0;c<b.length;c++)b[c]=0;for(c=0;c<8*a.length;c+=8)b[c>>5]|=(a.charCodeAt(c/8)&255)<<24-c%32;return b}
function binb2rstr(a){for(var b="",c=0;c<32*a.length;c+=8)b+=String.fromCharCode(a[c>>5]>>>24-c%32&255);return b}
function binb_sha1(a,b){a[b>>5]|=128<<24-b%32;a[(b+64>>9<<4)+15]=b;for(var c=Array(80),d=1732584193,e=-271733879,f=-1732584194,g=271733878,k=-1009589776,h=0;h<a.length;h+=16){for(var m=d,p=e,n=f,l=g,u=k,q=0;80>q;q++){c[q]=16>q?a[h+q]:bit_rol(c[q-3]^c[q-8]^c[q-14]^c[q-16],1);var s=safe_add(safe_add(bit_rol(d,5),sha1_ft(q,e,f,g)),safe_add(safe_add(k,c[q]),sha1_kt(q))),k=g,g=f,f=bit_rol(e,30),e=d,d=s}d=safe_add(d,m);e=safe_add(e,p);f=safe_add(f,n);g=safe_add(g,l);k=safe_add(k,u)}return[d,e,f,g,k]}
function sha1_ft(a,b,c,d){return 20>a?b&c|~b&d:40>a?b^c^d:60>a?b&c|b&d|c&d:b^c^d}function sha1_kt(a){return 20>a?1518500249:40>a?1859775393:60>a?-1894007588:-899497514}function hex_md5(a){return rstr2hex(rstr_md5(str2rstr_utf8(a)))}function b64_md5(a){return rstr2b64(rstr_md5(str2rstr_utf8(a)))}function any_md5(a,b){return rstr2any(rstr_md5(str2rstr_utf8(a)),b)}function hex_hmac_md5(a,b){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(b)))}
function b64_hmac_md5(a,b){return rstr2b64(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(b)))}function any_hmac_md5(a,b,c){return rstr2any(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(b)),c)}function md5_vm_test(){return"900150983cd24fb0d6963f7d28e17f72"==hex_md5("abc").toLowerCase()}function rstr_md5(a){return binl2rstr(binl_md5(rstr2binl(a),8*a.length))}
function rstr_hmac_md5(a,b){var c=rstr2binl(a);16<c.length&&(c=binl_md5(c,8*a.length));for(var d=Array(16),e=Array(16),f=0;16>f;f++)d[f]=c[f]^909522486,e[f]=c[f]^1549556828;c=binl_md5(d.concat(rstr2binl(b)),512+8*b.length);return binl2rstr(binl_md5(e.concat(c),640))}function rstr2hex(a){try{hexcase}catch(b){hexcase=0}for(var c=hexcase?"0123456789ABCDEF":"0123456789abcdef",d="",e,f=0;f<a.length;f++)e=a.charCodeAt(f),d+=c.charAt(e>>>4&15)+c.charAt(e&15);return d}
function rstr2b64(a){try{b64pad}catch(b){b64pad=""}for(var c="",d=a.length,e=0;e<d;e+=3)for(var f=a.charCodeAt(e)<<16|(e+1<d?a.charCodeAt(e+1)<<8:0)|(e+2<d?a.charCodeAt(e+2):0),g=0;4>g;g++)c=8*e+6*g>8*a.length?c+b64pad:c+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(f>>>6*(3-g)&63);return c}
function rstr2any(a,b){var c=b.length,d,e,f,g,k,h=Array(Math.ceil(a.length/2));for(d=0;d<h.length;d++)h[d]=a.charCodeAt(2*d)<<8|a.charCodeAt(2*d+1);var m=Math.ceil(8*a.length/(Math.log(b.length)/Math.log(2))),p=Array(m);for(e=0;e<m;e++){k=[];for(d=g=0;d<h.length;d++)if(g=(g<<16)+h[d],f=Math.floor(g/c),g-=f*c,0<k.length||0<f)k[k.length]=f;p[e]=g;h=k}c="";for(d=p.length-1;0<=d;d--)c+=b.charAt(p[d]);return c}
function str2rstr_utf8(a){for(var b="",c=-1,d,e;++c<a.length;)d=a.charCodeAt(c),e=c+1<a.length?a.charCodeAt(c+1):0,55296<=d&&(56319>=d&&56320<=e&&57343>=e)&&(d=65536+((d&1023)<<10)+(e&1023),c++),127>=d?b+=String.fromCharCode(d):2047>=d?b+=String.fromCharCode(192|d>>>6&31,128|d&63):65535>=d?b+=String.fromCharCode(224|d>>>12&15,128|d>>>6&63,128|d&63):2097151>=d&&(b+=String.fromCharCode(240|d>>>18&7,128|d>>>12&63,128|d>>>6&63,128|d&63));return b}
function str2rstr_utf16le(a){for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a.charCodeAt(c)&255,a.charCodeAt(c)>>>8&255);return b}function str2rstr_utf16be(a){for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a.charCodeAt(c)>>>8&255,a.charCodeAt(c)&255);return b}function rstr2binl(a){for(var b=Array(a.length>>2),c=0;c<b.length;c++)b[c]=0;for(c=0;c<8*a.length;c+=8)b[c>>5]|=(a.charCodeAt(c/8)&255)<<c%32;return b}
function binl2rstr(a){for(var b="",c=0;c<32*a.length;c+=8)b+=String.fromCharCode(a[c>>5]>>>c%32&255);return b}
function binl_md5(a,b){a[b>>5]|=128<<b%32;a[(b+64>>>9<<4)+14]=b;for(var c=1732584193,d=-271733879,e=-1732584194,f=271733878,g=0;g<a.length;g+=16)var k=c,h=d,m=e,p=f,c=md5_ff(c,d,e,f,a[g+0],7,-680876936),f=md5_ff(f,c,d,e,a[g+1],12,-389564586),e=md5_ff(e,f,c,d,a[g+2],17,606105819),d=md5_ff(d,e,f,c,a[g+3],22,-1044525330),c=md5_ff(c,d,e,f,a[g+4],7,-176418897),f=md5_ff(f,c,d,e,a[g+5],12,1200080426),e=md5_ff(e,f,c,d,a[g+6],17,-1473231341),d=md5_ff(d,e,f,c,a[g+7],22,-45705983),c=md5_ff(c,d,e,f,a[g+8],7,
1770035416),f=md5_ff(f,c,d,e,a[g+9],12,-1958414417),e=md5_ff(e,f,c,d,a[g+10],17,-42063),d=md5_ff(d,e,f,c,a[g+11],22,-1990404162),c=md5_ff(c,d,e,f,a[g+12],7,1804603682),f=md5_ff(f,c,d,e,a[g+13],12,-40341101),e=md5_ff(e,f,c,d,a[g+14],17,-1502002290),d=md5_ff(d,e,f,c,a[g+15],22,1236535329),c=md5_gg(c,d,e,f,a[g+1],5,-165796510),f=md5_gg(f,c,d,e,a[g+6],9,-1069501632),e=md5_gg(e,f,c,d,a[g+11],14,643717713),d=md5_gg(d,e,f,c,a[g+0],20,-373897302),c=md5_gg(c,d,e,f,a[g+5],5,-701558691),f=md5_gg(f,c,d,e,a[g+
10],9,38016083),e=md5_gg(e,f,c,d,a[g+15],14,-660478335),d=md5_gg(d,e,f,c,a[g+4],20,-405537848),c=md5_gg(c,d,e,f,a[g+9],5,568446438),f=md5_gg(f,c,d,e,a[g+14],9,-1019803690),e=md5_gg(e,f,c,d,a[g+3],14,-187363961),d=md5_gg(d,e,f,c,a[g+8],20,1163531501),c=md5_gg(c,d,e,f,a[g+13],5,-1444681467),f=md5_gg(f,c,d,e,a[g+2],9,-51403784),e=md5_gg(e,f,c,d,a[g+7],14,1735328473),d=md5_gg(d,e,f,c,a[g+12],20,-1926607734),c=md5_hh(c,d,e,f,a[g+5],4,-378558),f=md5_hh(f,c,d,e,a[g+8],11,-2022574463),e=md5_hh(e,f,c,d,a[g+
11],16,1839030562),d=md5_hh(d,e,f,c,a[g+14],23,-35309556),c=md5_hh(c,d,e,f,a[g+1],4,-1530992060),f=md5_hh(f,c,d,e,a[g+4],11,1272893353),e=md5_hh(e,f,c,d,a[g+7],16,-155497632),d=md5_hh(d,e,f,c,a[g+10],23,-1094730640),c=md5_hh(c,d,e,f,a[g+13],4,681279174),f=md5_hh(f,c,d,e,a[g+0],11,-358537222),e=md5_hh(e,f,c,d,a[g+3],16,-722521979),d=md5_hh(d,e,f,c,a[g+6],23,76029189),c=md5_hh(c,d,e,f,a[g+9],4,-640364487),f=md5_hh(f,c,d,e,a[g+12],11,-421815835),e=md5_hh(e,f,c,d,a[g+15],16,530742520),d=md5_hh(d,e,f,
c,a[g+2],23,-995338651),c=md5_ii(c,d,e,f,a[g+0],6,-198630844),f=md5_ii(f,c,d,e,a[g+7],10,1126891415),e=md5_ii(e,f,c,d,a[g+14],15,-1416354905),d=md5_ii(d,e,f,c,a[g+5],21,-57434055),c=md5_ii(c,d,e,f,a[g+12],6,1700485571),f=md5_ii(f,c,d,e,a[g+3],10,-1894986606),e=md5_ii(e,f,c,d,a[g+10],15,-1051523),d=md5_ii(d,e,f,c,a[g+1],21,-2054922799),c=md5_ii(c,d,e,f,a[g+8],6,1873313359),f=md5_ii(f,c,d,e,a[g+15],10,-30611744),e=md5_ii(e,f,c,d,a[g+6],15,-1560198380),d=md5_ii(d,e,f,c,a[g+13],21,1309151649),c=md5_ii(c,
d,e,f,a[g+4],6,-145523070),f=md5_ii(f,c,d,e,a[g+11],10,-1120210379),e=md5_ii(e,f,c,d,a[g+2],15,718787259),d=md5_ii(d,e,f,c,a[g+9],21,-343485551),c=safe_add(c,k),d=safe_add(d,h),e=safe_add(e,m),f=safe_add(f,p);return[c,d,e,f]}function md5_cmn(a,b,c,d,e,f){return safe_add(bit_rol(safe_add(safe_add(b,a),safe_add(d,f)),e),c)}function md5_ff(a,b,c,d,e,f,g){return md5_cmn(b&c|~b&d,a,b,e,f,g)}function md5_gg(a,b,c,d,e,f,g){return md5_cmn(b&d|c&~d,a,b,e,f,g)}
function md5_hh(a,b,c,d,e,f,g){return md5_cmn(b^c^d,a,b,e,f,g)}function md5_ii(a,b,c,d,e,f,g){return md5_cmn(c^(b|~d),a,b,e,f,g)}function safe_add(a,b){var c=(a&65535)+(b&65535);return(a>>16)+(b>>16)+(c>>16)<<16|c&65535}function bit_rol(a,b){return a<<b|a>>>32-b}
function utf8t2d(a){a=a.replace(/\r\n/g,"\n");var b=[];if(0>String.fromCharCode(237).charCodeAt(0))for(var c=0;c<a.length;c++){var d=a.charCodeAt(c);0<d?b[b.length]=d:(b[b.length]=256+d>>6|192,b[b.length]=256+d&63|128)}else for(c=0;c<a.length;c++)d=a.charCodeAt(c),128>d?b[b.length]=d:(127<d&&2048>d?b[b.length]=d>>6|192:(b[b.length]=d>>12|224,b[b.length]=d>>6&63|128),b[b.length]=d&63|128);return b}
function utf8d2t(a){for(var b=[],c=0;c<a.length;)128>a[c]?(b[b.length]=String.fromCharCode(a[c]),c++):191<a[c]&&224>a[c]?(b[b.length]=String.fromCharCode((a[c]&31)<<6|a[c+1]&63),c+=2):(b[b.length]=String.fromCharCode((a[c]&15)<<12|(a[c+1]&63)<<6|a[c+2]&63),c+=3);return b.join("")}
function b64arrays(){b64=[];f64=[];for(var a=0;64>a;a++)b64[a]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a),f64["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a)]=a}
function b64d2t(a){var b=[],c=0,d=a.length;1==d%3&&(a[a.length]=0,a[a.length]=0);for(2==d%3&&(a[a.length]=0);c<a.length;)b[b.length]=b64[a[c]>>2],b[b.length]=b64[(a[c]&3)<<4|a[c+1]>>4],b[b.length]=b64[(a[c+1]&15)<<2|a[c+2]>>6],b[b.length]=b64[a[c+2]&63],c+=3;1==d%3&&(b[b.length-1]=b[b.length-2]="=");2==d%3&&(b[b.length-1]="=");return b.join("")}
function b64t2d(a){var b=[],c=0;a=a.replace(/\n|\r/g,"");for(a=a.replace(/=/g,"");c<a.length;)b[b.length]=f64[a.charAt(c)]<<2|f64[a.charAt(c+1)]>>4,b[b.length]=(f64[a.charAt(c+1)]&15)<<4|f64[a.charAt(c+2)]>>2,b[b.length]=(f64[a.charAt(c+2)]&3)<<6|f64[a.charAt(c+3)],c+=4;2==a.length%4&&(b=b.slice(0,b.length-2));3==a.length%4&&(b=b.slice(0,b.length-1));return b}("undefined"==typeof atob||"undefined"==typeof btoa)&&b64arrays();
"undefined"==typeof atob?(b64decode=function(a){return utf8d2t(b64t2d(a))},b64decode_bin=function(a){a=b64t2d(a);for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a[c]);return b}):(b64decode=function(a){return decodeURIComponent(escape(atob(a)))},b64decode_bin=atob);b64encode="undefined"==typeof btoa?function(a){return b64d2t(utf8t2d(a))}:function(a){return btoa(unescape(encodeURIComponent(a)))};function JSJaCJSON(){}
JSJaCJSON.toString=function(a){var b={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},c={array:function(a){var b=["["],f,g,k,h=a.length,m;for(k=0;k<h;k+=1)if(m=a[k],g=c[typeof m])try{m=g(m),"string"==typeof m&&(f&&(b[b.length]=","),b[b.length]=m,f=!0)}catch(p){}b[b.length]="]";return b.join("")},"boolean":function(a){return String(a)},"null":function(){return"null"},number:function(a){return isFinite(a)?String(a):"null"},object:function(a){if(a){if(a instanceof Array)return c.array(a);
var b=[],f,g,k,h;b.push("{");for(k in a)if(a.hasOwnProperty(k)&&(h=a[k],g=c[typeof h]))try{h=g(h),"string"==typeof h&&(f&&(b[b.length]=","),b.push(c.string(k),":",h),f=!0)}catch(m){}b[b.length]="}";return b.join("")}return"null"},string:function(a){/["\\\x00-\x1f]/.test(a)&&(a=a.replace(/([\x00-\x1f\\"])/g,function(a,c){var d=b[c];if(d)return d;d=c.charCodeAt();return"\\u00"+Math.floor(d/16).toString(16)+(d%16).toString(16)}));return'"'+a+'"'}};switch(typeof a){case "object":return c.object(a);case "array":return c.array(a)}};
JSJaCJSON.parse=function(a){try{return!/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/.test(a.replace(/"(\\.|[^"\\])*"/g,""))&&eval("("+a+")")}catch(b){return!1}};function XmlHttp(){}
XmlHttp.create=function(){try{if(window.XMLHttpRequest){var a=new XMLHttpRequest;null===a.readyState&&(a.readyState=1,a.addEventListener("load",function(){a.readyState=4;if("function"==typeof a.onreadystatechange)a.onreadystatechange()},!1));return a}if(window.ActiveXObject)return new ActiveXObject(XmlHttp.getPrefix()+".XmlHttp")}catch(b){}throw Error("Your browser does not support XmlHttp objects");};
XmlHttp.getPrefix=function(){if(XmlHttp.prefix)return XmlHttp.prefix;for(var a=["MSXML2","Microsoft","MSXML","MSXML3"],b=0;b<a.length;b++)try{return new ActiveXObject(a[b]+".XmlHttp"),XmlHttp.prefix=a[b]}catch(c){}throw Error("Could not find an installed XML parser");};function XmlDocument(){}
XmlDocument.create=function(a,b){a=a||"foo";b=b||"";try{var c;document.implementation&&document.implementation.createDocument?(c=document.implementation.createDocument(b,a,null),null===c.readyState&&(c.readyState=1,c.addEventListener("load",function(){c.readyState=4;if("function"==typeof c.onreadystatechange)c.onreadystatechange()},!1))):window.ActiveXObject&&(c=new ActiveXObject(XmlDocument.getPrefix()+".DomDocument"));if(!c.documentElement||c.documentElement.tagName!=a||c.documentElement.namespaceURI&&
c.documentElement.namespaceURI!=b)try{""!==b?c.appendChild(c.createElement(a)).setAttribute("xmlns",b):c.appendChild(c.createElement(a))}catch(d){c=document.implementation.createDocument(b,a,null),null===c.documentElement&&c.appendChild(c.createElement(a)),""!==b&&c.documentElement.getAttribute("xmlns")!=b&&c.documentElement.setAttribute("xmlns",b)}return c}catch(e){}throw Error("Your browser does not support XmlDocument objects");};
XmlDocument.getPrefix=function(){if(XmlDocument.prefix)return XmlDocument.prefix;for(var a=["MSXML2","Microsoft","MSXML","MSXML3"],b=0;b<a.length;b++)try{return new ActiveXObject(a[b]+".DomDocument"),XmlDocument.prefix=a[b]}catch(c){}throw Error("Could not find an installed XML parser");};
"undefined"!=typeof Document&&window.DOMParser&&(Document.prototype.loadXML=function(a){for(a=(new DOMParser).parseFromString(a,"text/xml");this.hasChildNodes();)this.removeChild(this.lastChild);for(var b=0;b<a.childNodes.length;b++)this.appendChild(this.importNode(a.childNodes[b],!0))});
window.XMLSerializer&&(window.Node&&Node.prototype&&Node.prototype.__defineGetter__)&&(XMLDocument.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}),Document.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}),Node.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}));
var JSJaCUtils={xor:function(a,b){if(!a)return b;if(!b)return a;for(var c="",d=0;d<a.length;d++)c+=String.fromCharCode(a.charCodeAt(d)^b.charCodeAt(d));return c},cnonce:function(a){for(var b="",c=0;c<a;c++)b+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.round(61*Math.random((new Date).getTime())));return b},now:function(){return Date.now&&"function"==typeof Date.now?Date.now():(new Date).getTime()}},JSJaCBuilder={buildNode:function(a,b,c,d,e){if(c)if(JSJaCBuilder._isStringOrNumber(c)||
c instanceof Array)b=this._createElement(a,b,e),JSJaCBuilder._children(a,b,c);else{e=c.xmlns||e;b=this._createElement(a,b,e);for(var f in c)c.hasOwnProperty(f)&&"xmlns"!=f&&b.setAttribute(f,c[f])}else b=this._createElement(a,b,e);d&&JSJaCBuilder._children(a,b,d,e);return b},_createElement:function(a,b,c){try{if(c)return a.createElementNS(c,b)}catch(d){}a=a.createElement(b);c&&a.setAttribute("xmlns",c);return a},_text:function(a,b){return a.createTextNode(b)},_children:function(a,b,c,d){if("object"==
typeof c)for(var e in c){if(c.hasOwnProperty(e)){var f=c[e];"object"==typeof f?(f instanceof Array&&(f=JSJaCBuilder.buildNode(a,f[0],f[1],f[2],d)),b.appendChild(f)):JSJaCBuilder._isStringOrNumber(f)&&b.appendChild(JSJaCBuilder._text(a,f))}}else JSJaCBuilder._isStringOrNumber(c)&&b.appendChild(JSJaCBuilder._text(a,c))},_attributes:function(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(c+'="'+a[c].toString().htmlEnc()+'"');return b.join(" ")},_isStringOrNumber:function(a){return"string"==typeof a||
"number"==typeof a}},NS_DISCO_ITEMS="http://jabber.org/protocol/disco#items",NS_DISCO_INFO="http://jabber.org/protocol/disco#info",NS_VCARD="vcard-temp",NS_VCARD_UPDATE="vcard-temp:x:update",NS_AUTH="jabber:iq:auth",NS_AUTH_ERROR="jabber:iq:auth:error",NS_REGISTER="jabber:iq:register",NS_SEARCH="jabber:iq:search",NS_ROSTER="jabber:iq:roster",NS_PRIVACY="jabber:iq:privacy",NS_PRIVATE="jabber:iq:private",NS_VERSION="jabber:iq:version",NS_TIME="jabber:iq:time",NS_TIME_NEW="urn:xmpp:time",NS_LAST="jabber:iq:last",
NS_XDATA="jabber:x:data",NS_IQDATA="jabber:iq:data",NS_DELAY="jabber:x:delay",NS_DELAY_NEW="urn:xmpp:delay",NS_EXPIRE="jabber:x:expire",NS_EVENT="jabber:x:event",NS_XCONFERENCE="jabber:x:conference",NS_PING="urn:xmpp:ping",NS_BOOKSMARKS="storage:bookmarks",NS_FORWARD_0="urn:xmpp:forward:0",NS_CARBONS_2="urn:xmpp:carbons:2",NS_CHAT_STATES="http://jabber.org/protocol/chatstates",NS_STATS="http://jabber.org/protocol/stats",NS_MUC="http://jabber.org/protocol/muc",NS_MUC_USER="http://jabber.org/protocol/muc#user",
NS_MUC_ADMIN="http://jabber.org/protocol/muc#admin",NS_MUC_OWNER="http://jabber.org/protocol/muc#owner",NS_PUBSUB="http://jabber.org/protocol/pubsub",NS_PUBSUB_EVENT="http://jabber.org/protocol/pubsub#event",NS_PUBSUB_OWNER="http://jabber.org/protocol/pubsub#owner",NS_PUBSUB_ERRORS="http://jabber.org/protocol/pubsub#errors",NS_PUBSUB_NMI="http://jabber.org/protocol/pubsub#node-meta-info",NS_COMMANDS="http://jabber.org/protocol/commands",NS_CAPS="http://jabber.org/protocol/caps",NS_STREAM="http://etherx.jabber.org/streams",
NS_CLIENT="jabber:client",NS_BOSH="http://jabber.org/protocol/httpbind",NS_XBOSH="urn:xmpp:xbosh",NS_STANZAS="urn:ietf:params:xml:ns:xmpp-stanzas",NS_STREAMS="urn:ietf:params:xml:ns:xmpp-streams",NS_TLS="urn:ietf:params:xml:ns:xmpp-tls",NS_SASL="urn:ietf:params:xml:ns:xmpp-sasl",NS_SESSION="urn:ietf:params:xml:ns:xmpp-session",NS_BIND="urn:ietf:params:xml:ns:xmpp-bind",NS_FEATURE_IQAUTH="http://jabber.org/features/iq-auth",NS_FEATURE_IQREGISTER="http://jabber.org/features/iq-register",NS_FEATURE_COMPRESS=
"http://jabber.org/features/compress",NS_COMPRESS="http://jabber.org/protocol/compress";function STANZA_ERROR(a,b,c){if(window==this)return new STANZA_ERROR(a,b,c);this.code=a;this.type=b;this.cond=c}
var ERR_BAD_REQUEST=STANZA_ERROR("400","modify","bad-request"),ERR_CONFLICT=STANZA_ERROR("409","cancel","conflict"),ERR_FEATURE_NOT_IMPLEMENTED=STANZA_ERROR("501","cancel","feature-not-implemented"),ERR_FORBIDDEN=STANZA_ERROR("403","auth","forbidden"),ERR_GONE=STANZA_ERROR("302","modify","gone"),ERR_INTERNAL_SERVER_ERROR=STANZA_ERROR("500","wait","internal-server-error"),ERR_ITEM_NOT_FOUND=STANZA_ERROR("404","cancel","item-not-found"),ERR_JID_MALFORMED=STANZA_ERROR("400","modify","jid-malformed"),
ERR_NOT_ACCEPTABLE=STANZA_ERROR("406","modify","not-acceptable"),ERR_NOT_ALLOWED=STANZA_ERROR("405","cancel","not-allowed"),ERR_NOT_AUTHORIZED=STANZA_ERROR("401","auth","not-authorized"),ERR_PAYMENT_REQUIRED=STANZA_ERROR("402","auth","payment-required"),ERR_RECIPIENT_UNAVAILABLE=STANZA_ERROR("404","wait","recipient-unavailable"),ERR_REDIRECT=STANZA_ERROR("302","modify","redirect"),ERR_REGISTRATION_REQUIRED=STANZA_ERROR("407","auth","registration-required"),ERR_REMOTE_SERVER_NOT_FOUND=STANZA_ERROR("404",
"cancel","remote-server-not-found"),ERR_REMOTE_SERVER_TIMEOUT=STANZA_ERROR("504","wait","remote-server-timeout"),ERR_RESOURCE_CONSTRAINT=STANZA_ERROR("500","wait","resource-constraint"),ERR_SERVICE_UNAVAILABLE=STANZA_ERROR("503","cancel","service-unavailable"),ERR_SUBSCRIPTION_REQUIRED=STANZA_ERROR("407","auth","subscription-required"),ERR_UNEXPECTED_REQUEST=STANZA_ERROR("400","wait","unexpected-request");
function JSJaCConsoleLogger(a){this.level=a||4;this.start=function(){};this.log=function(a,c){c=c||0;if(!(c>this.level)&&"undefined"!=typeof console)try{switch(c){case 0:console.warn(a);break;case 1:console.error(a);break;case 2:console.info(a);break;case 4:console.debug(a);break;default:console.log(a)}}catch(d){try{console.log(a)}catch(e){}}};this.setLevel=function(a){this.level=a;return this};this.getLevel=function(){return this.level}}
function JSJaCCookieException(a){this.message=a;this.name="CookieException"}
function JSJaCCookie(a,b,c,d,e){if(window==this)return new JSJaCCookie(a,b,c,d,e);this.name=a;this.value=b;this.secs=c;this.domain=d;this.path=e;this.write=function(){var a;this.secs?(a=new Date,a.setTime(a.getTime()+1E3*this.secs),a="; expires="+a.toGMTString()):a="";var b=this.domain?"; domain="+this.domain:"",c=this.path?"; path="+this.path:"; path=/";document.cookie=this.getName()+"="+JSJaCCookie._escape(this.getValue())+a+b+c};this.erase=function(){(new JSJaCCookie(this.getName(),"",-1)).write()};
this.getName=function(){return this.name};this.setName=function(a){this.name=a;return this};this.getValue=function(){return this.value};this.setValue=function(a){this.value=a;return this};this.setDomain=function(a){this.domain=a;return this};this.setPath=function(a){this.path=a;return this}}
JSJaCCookie.read=function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(b))return new JSJaCCookie(a,JSJaCCookie._unescape(e.substring(b.length,e.length)))}throw new JSJaCCookieException("Cookie not found");};JSJaCCookie.get=function(a){return JSJaCCookie.read(a).getValue()};JSJaCCookie.remove=function(a){JSJaCCookie.read(a).erase()};JSJaCCookie._escape=function(a){return a.replace(/;/g,"%3AB")};
JSJaCCookie._unescape=function(a){return a.replace(/%3AB/g,";")};function JSJaCError(a,b,c){var d=XmlDocument.create("error","jsjac");d.documentElement.setAttribute("code",a);d.documentElement.setAttribute("type",b);c&&d.documentElement.appendChild(d.createElement(c)).setAttribute("xmlns",NS_STANZAS);return d.documentElement}function JSJaCJIDInvalidException(a){this.message=a;this.name="JSJaCJIDInvalidException"}var JSJACJID_FORBIDDEN="\" &'/:<>@".split("");
function JSJaCJID(a){this._resource=this._domain=this._node="";"string"==typeof a?(-1!=a.indexOf("@")&&(this.setNode(a.substring(0,a.indexOf("@"))),a=a.substring(a.indexOf("@")+1)),-1!=a.indexOf("/")&&(this.setResource(a.substring(a.indexOf("/")+1)),a=a.substring(0,a.indexOf("/"))),this.setDomain(a)):(this.setNode(a.node),this.setDomain(a.domain),this.setResource(a.resource))}JSJaCJID.prototype.getBareJID=function(){return this.getNode()+"@"+this.getDomain()};JSJaCJID.prototype.getNode=function(){return this._node};
JSJaCJID.prototype.getDomain=function(){return this._domain};JSJaCJID.prototype.getResource=function(){return this._resource};JSJaCJID.prototype.setNode=function(a){JSJaCJID._checkNodeName(a);this._node=a||"";return this};JSJaCJID.prototype.setDomain=function(a){if(!a||""===a)throw new JSJaCJIDInvalidException("domain name missing");JSJaCJID._checkNodeName(a);this._domain=a;return this};JSJaCJID.prototype.setResource=function(a){this._resource=a||"";return this};
JSJaCJID.prototype.toString=function(){var a="";this.getNode()&&""!==this.getNode()&&(a=this.getNode()+"@");a+=this.getDomain();this.getResource()&&""!==this.getResource()&&(a+="/"+this.getResource());return a};JSJaCJID.prototype.removeResource=function(){return this.setResource()};JSJaCJID.prototype.clone=function(){return new JSJaCJID(this.toString())};
JSJaCJID.prototype.isEntity=function(a){a="string"==typeof a?new JSJaCJID(a):a.clone();a.removeResource();return this.clone().removeResource().toString()===a.toString()};JSJaCJID._checkNodeName=function(a){if(a&&""!==a)for(var b=0;b<JSJACJID_FORBIDDEN.length;b++)if(-1!=a.indexOf(JSJACJID_FORBIDDEN[b]))throw new JSJaCJIDInvalidException("forbidden char in nodename: "+JSJACJID_FORBIDDEN[b]);};
function JSJaCKeys(a,b){var c=Math.random();this._k=[];this._k[0]=c.toString();b?this.oDbg=b:(this.oDbg={},this.oDbg.log=function(){});if(a)for(c=1;c<JSJAC_NKEYS;c++)this._k[c]=a(this._k[c-1]),b.log(c+": "+this._k[c],4);this._indexAt=JSJAC_NKEYS-1;this.getKey=function(){return this._k[this._indexAt--]};this.lastKey=function(){return 0===this._indexAt};this.size=function(){return this._k.length};this._getSuspendVars=function(){return["_k","_indexAt"]}}var JSJACPACKET_USE_XMLNS=!0;
function JSJaCPacket(a){this.name=a;this.doc="undefined"!=typeof JSJACPACKET_USE_XMLNS&&JSJACPACKET_USE_XMLNS?XmlDocument.create(a,NS_CLIENT):XmlDocument.create(a,"")}JSJaCPacket.prototype.pType=function(){return this.name};JSJaCPacket.prototype.getDoc=function(){return this.doc};JSJaCPacket.prototype.getNode=function(){return this.getDoc()&&this.getDoc().documentElement?this.getDoc().documentElement:null};
JSJaCPacket.prototype.setTo=function(a){a?"string"==typeof a?this.getNode().setAttribute("to",a):this.getNode().setAttribute("to",a.toString()):this.getNode().removeAttribute("to");return this};JSJaCPacket.prototype.setFrom=function(a){a?"string"==typeof a?this.getNode().setAttribute("from",a):this.getNode().setAttribute("from",a.toString()):this.getNode().removeAttribute("from");return this};
JSJaCPacket.prototype.setID=function(a){a?this.getNode().setAttribute("id",a):this.getNode().removeAttribute("id");return this};JSJaCPacket.prototype.setType=function(a){a?this.getNode().setAttribute("type",a):this.getNode().removeAttribute("type");return this};JSJaCPacket.prototype.setXMLLang=function(a){a?this.getNode().setAttribute("xml:lang",a):this.getNode().removeAttribute("xml:lang");return this};JSJaCPacket.prototype.getTo=function(){return this.getNode().getAttribute("to")};
JSJaCPacket.prototype.getFrom=function(){return this.getNode().getAttribute("from")};JSJaCPacket.prototype.getToJID=function(){return new JSJaCJID(this.getTo())};JSJaCPacket.prototype.getFromJID=function(){return new JSJaCJID(this.getFrom())};JSJaCPacket.prototype.getID=function(){return this.getNode().getAttribute("id")};JSJaCPacket.prototype.getType=function(){return this.getNode().getAttribute("type")};JSJaCPacket.prototype.getXMLLang=function(){return this.getNode().getAttribute("xml:lang")};
JSJaCPacket.prototype.getXMLNS=function(){return this.getNode().namespaceURI||this.getNode().getAttribute("xmlns")};JSJaCPacket.prototype.getChild=function(a,b){if(!this.getNode())return null;a=a||"*";b=b||"*";if(this.getNode().getElementsByTagNameNS)return this.getNode().getElementsByTagNameNS(b,a).item(0);var c=this.getNode().getElementsByTagName(a);if("*"!=b)for(var d=0;d<c.length;d++){if(c.item(d).namespaceURI==b||c.item(d).getAttribute("xmlns")==b)return c.item(d)}else return c.item(0);return null};
JSJaCPacket.prototype.getChildVal=function(a,b){var c=this.getChild(a,b),d="";if(c&&c.hasChildNodes())for(var e=0;e<c.childNodes.length;e++)c.childNodes.item(e).nodeValue&&(d+=c.childNodes.item(e).nodeValue);return d};JSJaCPacket.prototype.clone=function(){return JSJaCPacket.wrapNode(this.getNode())};JSJaCPacket.prototype.isError=function(){return"error"==this.getType()};
JSJaCPacket.prototype.errorReply=function(a){var b=this.clone();b.setTo(this.getFrom());b.setFrom();b.setType("error");b.appendNode("error",{code:a.code,type:a.type},[[a.cond,{xmlns:NS_STANZAS}]]);return b};JSJaCPacket.prototype.xml="undefined"!=typeof XMLSerializer?function(){var a=(new XMLSerializer).serializeToString(this.getNode());"undefined"==typeof a&&(a=(new XMLSerializer).serializeToString(this.doc));return a}:function(){return this.getDoc().xml};JSJaCPacket.prototype._getAttribute=function(a){return this.getNode().getAttribute(a)};
document.ELEMENT_NODE||(document.ELEMENT_NODE=1,document.ATTRIBUTE_NODE=2,document.TEXT_NODE=3,document.CDATA_SECTION_NODE=4,document.ENTITY_REFERENCE_NODE=5,document.ENTITY_NODE=6,document.PROCESSING_INSTRUCTION_NODE=7,document.COMMENT_NODE=8,document.DOCUMENT_NODE=9,document.DOCUMENT_TYPE_NODE=10,document.DOCUMENT_FRAGMENT_NODE=11,document.NOTATION_NODE=12);
JSJaCPacket.prototype._importNode=function(a,b){switch(a.nodeType){case document.ELEMENT_NODE:var c;c=this.getDoc().createElementNS?this.getDoc().createElementNS(a.namespaceURI,a.nodeName):this.getDoc().createElement(a.nodeName);var d,e;if(a.attributes&&0<a.attributes.length){d=0;for(e=a.attributes.length;d<e;d++){var f=a.attributes.item(d);"xmlns"==f.nodeName&&(null!==c.getAttribute("xmlns")||c.namespaceURI)||(c.setAttributeNS&&f.namespaceURI?c.setAttributeNS(f.namespaceURI,f.name,f.value):c.setAttribute(f.name,
f.value))}}if(b&&a.childNodes&&0<a.childNodes.length){d=0;for(e=a.childNodes.length;d<e;d++)c.appendChild(this._importNode(a.childNodes.item(d),b))}return c;case document.TEXT_NODE:case document.CDATA_SECTION_NODE:case document.COMMENT_NODE:return this.getDoc().createTextNode(a.nodeValue)}};
JSJaCPacket.prototype._setChildNode=function(a,b){var c=this.getChild(a),d=this.getDoc().createTextNode(b);if(c)try{c.replaceChild(d,c.firstChild)}catch(e){}else{try{c=this.getDoc().createElementNS(this.getNode().namespaceURI,a)}catch(f){c=this.getDoc().createElement(a)}this.getNode().appendChild(c);c.appendChild(d)}return c};JSJaCPacket.prototype.buildNode=function(a,b,c,d){return JSJaCBuilder.buildNode(this.getDoc(),a,b,c,d)};
JSJaCPacket.prototype.appendNode=function(a,b,c){return"object"==typeof a?this.getNode().appendChild(a):this.getNode().appendChild(this.buildNode(a,b,c,this.getNode().namespaceURI))};function JSJaCPresence(){this.base=JSJaCPacket;this.base("presence")}JSJaCPresence.prototype=new JSJaCPacket;JSJaCPresence.prototype.setStatus=function(a){this._setChildNode("status",a);return this};JSJaCPresence.prototype.setShow=function(a){("chat"==a||"away"==a||"xa"==a||"dnd"==a)&&this._setChildNode("show",a);return this};
JSJaCPresence.prototype.setPriority=function(a){this._setChildNode("priority",a);return this};JSJaCPresence.prototype.setPresence=function(a,b,c){a&&this.setShow(a);b&&this.setStatus(b);c&&this.setPriority(c);return this};JSJaCPresence.prototype.getStatus=function(){return this.getChildVal("status")};JSJaCPresence.prototype.getShow=function(){return this.getChildVal("show")};JSJaCPresence.prototype.getPriority=function(){return this.getChildVal("priority")};
function JSJaCIQ(){this.base=JSJaCPacket;this.base("iq")}JSJaCIQ.prototype=new JSJaCPacket;JSJaCIQ.prototype.setIQ=function(a,b,c){a&&this.setTo(a);b&&this.setType(b);c&&this.setID(c);return this};JSJaCIQ.prototype.setQuery=function(a){var b;try{b=this.getDoc().createElementNS(a,"query")}catch(c){b=this.getDoc().createElement("query"),b.setAttribute("xmlns",a)}this.getNode().appendChild(b);return b};JSJaCIQ.prototype.getQuery=function(){return this.getNode().getElementsByTagName("query").item(0)};
JSJaCIQ.prototype.getQueryXMLNS=function(){return this.getQuery()?this.getQuery().namespaceURI||this.getQuery().getAttribute("xmlns"):null};
JSJaCIQ.prototype.reply=function(a){var b=this.clone();b.setTo(this.getFrom());b.setFrom();b.setType("result");if(a)if("string"==typeof a)b.getChild().appendChild(b.getDoc().loadXML(a));else if(a.constructor==Array)for(var c=b.getChild(),d=0;d<a.length;d++)"string"==typeof a[d]?c.appendChild(b.getDoc().loadXML(a[d])):"object"==typeof a[d]&&c.appendChild(a[d]);else"object"==typeof a&&b.getChild().appendChild(a);return b};function JSJaCMessage(){this.base=JSJaCPacket;this.base("message")}
JSJaCMessage.prototype=new JSJaCPacket;JSJaCMessage.prototype.setBody=function(a){this._setChildNode("body",a);return this};JSJaCMessage.prototype.setSubject=function(a){this._setChildNode("subject",a);return this};JSJaCMessage.prototype.setThread=function(a){this._setChildNode("thread",a);return this};JSJaCMessage.prototype.getThread=function(){return this.getChildVal("thread")};JSJaCMessage.prototype.getBody=function(){return this.getChildVal("body")};JSJaCMessage.prototype.getSubject=function(){return this.getChildVal("subject")};
JSJaCPacket.wrapNode=function(a){var b=null;switch(a.nodeName.toLowerCase()){case "presence":b=new JSJaCPresence;break;case "message":b=new JSJaCMessage;break;case "iq":b=new JSJaCIQ}b&&b.getDoc().replaceChild(b._importNode(a,!0),b.getNode());return b};
function JSJaCConnection(a){a&&a.httpbase&&(this._httpbase=a.httpbase);this.oDbg=a&&a.oDbg&&a.oDbg.log?a.oDbg:{log:function(){}};a&&a.timerval?this.setPollInterval(a.timerval):this.setPollInterval(JSJAC_TIMERVAL);this._cookie_prefix=a&&a.cookie_prefix?a.cookie_prefix:"";this._uniqueid=a&&a.uniqueid?a.uniqueid:"";this._connected=!1;this._events=[];this._keys=null;this._ID=0;this._inQ=[];this._pQueue=[];this._regIDs=[];this._req=[];this._status="intialized";this._errcnt=0;this._inactivity=JSJAC_INACTIVITY;
this._sendRawCallbacks=[]}
JSJaCConnection.prototype.connect=function(a){this._setStatus("connecting");this.domain=a.domain||"localhost";this.username=a.username;this.resource=a.resource;this.pass=a.password||a.pass;this.authzid=a.authzid||"";this.register=a.register;this.authhost=a.authhost||a.host||a.domain;this.authtype=a.authtype||"sasl";this._xmllang=a.xmllang&&""!==a.xmllang?a.xmllang:"en";this._allow_plain=a.allow_plain?a.allow_plain:JSJAC_ALLOW_PLAIN;this._allow_scram=a.allow_scram?a.allow_scram:JSJAC_ALLOW_SCRAM;this.host=
a.host;this.port=a.port||5222;this.jid=this.username+"@"+this.domain;this.fulljid=this.jid+"/"+this.resource;this._rid=Math.round(100000.5+799999.99999*Math.random());var b=this._getFreeSlot();this._req[b]=this._setupRequest(!0);a=this._getInitialRequestString();this.oDbg.log(a,4);this._req[b].r.onreadystatechange=JSJaC.bind(function(){var a=this._req[b].r;4==a.readyState&&(this.oDbg.log("async recv: "+a.responseText,4),this._handleInitialResponse(a))},this);"undefined"!=typeof this._req[b].r.onerror&&
(this._req[b].r.onerror=JSJaC.bind(function(){this.oDbg.log("XmlHttpRequest error",1)},this));this._req[b].r.send(a)};JSJaCConnection.prototype.connected=function(){return this._connected};
JSJaCConnection.prototype.disconnect=function(){this._setStatus("disconnecting");if(this.connected()){this._connected=!1;clearInterval(this._interval);clearInterval(this._inQto);this._timeout&&clearTimeout(this._timeout);var a=this._getFreeSlot();this._req[a]=this._setupRequest(!1);var b=this._getRequestString(!1,!0);this.oDbg.log("Disconnecting: "+b,4);try{this._req[a].r.send(b)}catch(c){}this.oDbg.log("disconnected");try{JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase()}catch(d){}this._handleEvent("ondisconnect")}};
JSJaCConnection.prototype.getPollInterval=function(){return this._timerval};
JSJaCConnection.prototype.registerHandler=function(a){a=a.toLowerCase();var b={handler:arguments[arguments.length-1],childName:"*",childNS:"*",type:"*"};2<arguments.length&&(b.childName=arguments[1]);3<arguments.length&&(b.childNS=arguments[2]);4<arguments.length&&(b.type=arguments[3]);this._events[a]=this._events[a]?this._events[a].concat(b):[b];this._events[a]=this._events[a].sort(function(a,b){var e=0,f=0;"*"==a.type&&e++;"*"==a.childNS&&e++;"*"==a.childName&&e++;"*"==b.type&&f++;"*"==b.childNS&&
f++;"*"==b.childName&&f++;return e>f?1:e<f?-1:0});this.oDbg.log("registered handler for event '"+a+"'",2);return this};JSJaCConnection.prototype.unregisterHandler=function(a,b){a=a.toLowerCase();if(!this._events[a])return this;for(var c=this._events[a],d=[],e=0;e<c.length;e++)c[e].handler!=b&&d.push(c[e]);c.length!=d.length&&(this._events[a]=d,this.oDbg.log("unregistered handler for event '"+a+"'",2));return this};
JSJaCConnection.prototype.registerIQGet=function(a,b,c){return this.registerHandler("iq",a,b,"get",c)};JSJaCConnection.prototype.registerIQSet=function(a,b,c){return this.registerHandler("iq",a,b,"set",c)};JSJaCConnection.prototype.resume=function(){try{var a=JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").getValue();this.oDbg.log("read cookie: "+a,2);JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase();return this.resumeFromData(JSJaCJSON.parse(a))}catch(b){}return!1};
JSJaCConnection.prototype.resumeFromData=function(a){try{for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);if(this._keys){this._keys2=new JSJaCKeys;var c=this._keys2._getSuspendVars();for(a=0;a<c.length;a++)this._keys2[c[a]]=this._keys[c[a]];this._keys=this._keys2}this._connected?(this._setStatus("resuming"),this._handleEvent("onresume"),setTimeout(JSJaC.bind(this._resume,this),this.getPollInterval()),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._inQto=
setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL)):this._setStatus("terminated");return!0===this._connected}catch(d){return d.message?this.oDbg.log("Resume failed: "+d.message,1):this.oDbg.log("Resume failed: "+d,1),!1}};
JSJaCConnection.prototype.send=function(a,b,c){if(!a||!a.pType)return this.oDbg.log("no packet: "+a,1),!1;if(!this.connected())return!1;b&&(a.getID()||a.setID(this._uniqueid+"_"+this._ID++),this._registerPID(a,b,c));this._pQueue=this._pQueue.concat(a.xml());this._handleEvent(a.pType()+"_out",a);this._handleEvent("packet_out",a);return!0};
JSJaCConnection.prototype.sendIQ=function(a,b,c){if(!a||"iq"!=a.pType())return!1;b=b||{};var d=b.error_handler||JSJaC.bind(function(a){this.oDbg.log(a.xml(),1)},this),e=b.result_handler||JSJaC.bind(function(a){this.oDbg.log(a.xml(),2)},this);return this.send(a,function(a,b){switch(a.getType()){case "error":d(a);break;case "result":e(a,b)}},c)};JSJaCConnection.prototype.setPollInterval=function(a){a&&!isNaN(a)&&(this._timerval=a);return this._timerval};JSJaCConnection.prototype.status=function(){return this._status};
JSJaCConnection.prototype.suspend=function(){var a=this.suspendToData();try{var b=new JSJaCCookie(this._cookie_prefix+"JSJaC_State",JSJaCJSON.toString(a));this.oDbg.log("writing cookie: "+b.getValue()+"\n(length:"+b.getValue().length+")",2);b.write();var c=JSJaCCookie.get(this._cookie_prefix+"JSJaC_State");return b.getValue()!=c?(this.oDbg.log("Suspend failed writing cookie.\nread: "+c,1),b.erase(),!1):!0}catch(d){this.oDbg.log("Failed creating cookie '"+this._cookie_prefix+"JSJaC_State': "+d.message,
1)}return!1};
JSJaCConnection.prototype.suspendToData=function(){clearTimeout(this._timeout);clearInterval(this._interval);clearInterval(this._inQto);this._suspend();for(var a="_connected _keys _ID _xmllang _inQ _pQueue _regIDs _errcnt _inactivity domain username resource jid fulljid _sid _httpbase _timerval _is_polling".split(" "),a=a.concat(this._getSuspendVars()),b={},c=0;c<a.length;c++)if(this[a[c]]){var d={};if(this[a[c]]._getSuspendVars)for(var e=this[a[c]]._getSuspendVars(),f=0;f<e.length;f++)d[e[f]]=this[a[c]][e[f]];
else d=this[a[c]];b[a[c]]=d}this._connected=!1;this._setStatus("suspending");return b};JSJaCConnection.prototype._abort=function(){clearTimeout(this._timeout);clearInterval(this._inQto);clearInterval(this._interval);this._connected=!1;this._setStatus("aborted");this.oDbg.log("Disconnected.",1);this._handleEvent("ondisconnect");this._handleEvent("onerror",JSJaCError("500","cancel","service-unavailable"))};
JSJaCConnection.prototype._checkInQ=function(){for(var a=0;a<this._inQ.length&&10>a;a++){var b=this._inQ[0];this._inQ=this._inQ.slice(1,this._inQ.length);b=JSJaCPacket.wrapNode(b);if(!b)break;this._handleEvent("packet_in",b);b.pType&&!this._handlePID(b)&&(this._handleEvent(b.pType()+"_in",b),this._handleEvent(b.pType(),b))}};JSJaCConnection.prototype._checkQueue=function(){0<this._pQueue.length&&this._process();return!0};
JSJaCConnection.prototype._doAuth=function(){this.has_sasl&&"nonsasl"==this.authtype&&this.oDbg.log("Warning: SASL present but not used",1);return!this._doSASLAuth()&&!this._doLegacyAuth()?(this.oDbg.log("Auth failed for authtype "+this.authtype,1),this.disconnect(),!1):!0};
JSJaCConnection.prototype._doInBandReg=function(){if(!("saslanon"==this.authtype||"anonymous"==this.authtype)){var a=new JSJaCIQ;a.setType("set");a.setID("reg1");a.appendNode("query",{xmlns:NS_REGISTER},[["username",this.username],["password",this.pass]]);this.send(a,this._doInBandRegDone)}};
JSJaCConnection.prototype._doInBandRegDone=function(a){a&&"error"==a.getType()?(this.oDbg.log("registration failed for "+this.username,0),this._handleEvent("onerror",a.getChild("error"))):(this.oDbg.log(this.username+" registered succesfully",0),this._doAuth())};
JSJaCConnection.prototype._doLegacyAuth=function(){if("nonsasl"!=this.authtype&&"anonymous"!=this.authtype)return!1;var a=new JSJaCIQ;a.setIQ(null,"get","auth1");a.appendNode("query",{xmlns:NS_AUTH},[["username",this.username]]);this.send(a,this._doLegacyAuth2);return!0};
JSJaCConnection.prototype._doLegacyAuth2=function(a){if(!a||"result"!=a.getType())a&&"error"==a.getType()&&this._handleEvent("onerror",a.getChild("error")),this.disconnect();else{a=null!==a.getChild("digest");var b=new JSJaCIQ;b.setIQ(null,"set","auth2");var c=b.appendNode("query",{xmlns:NS_AUTH},[["username",this.username],["resource",this.resource]]);if(a)c.appendChild(b.buildNode("digest",{xmlns:NS_AUTH},hex_sha1(this.streamid+this.pass)));else if(this._allow_plain)c.appendChild(b.buildNode("password",
{xmlns:NS_AUTH},this.pass));else{this.oDbg.log("no valid login mechanism found",1);this.disconnect();return}this.send(b,this._doLegacyAuthDone)}};JSJaCConnection.prototype._doLegacyAuthDone=function(a){"result"!=a.getType()?("error"==a.getType()&&this._handleEvent("onerror",a.getChild("error")),this.disconnect()):this._handleEvent("onconnect")};
JSJaCConnection.prototype._doSASLAuth=function(){if("nonsasl"==this.authtype||"anonymous"==this.authtype)return!1;if("saslanon"==this.authtype){if(this.mechs.ANONYMOUS)return this.oDbg.log("SASL using mechanism 'ANONYMOUS'",2),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='ANONYMOUS'/>",this._doSASLAuthDone);this.oDbg.log("SASL ANONYMOUS requested but not supported",1)}else{if(this._allow_scram&&this.mechs["SCRAM-SHA-1"]){this.oDbg.log("SASL using mechanism 'SCRAM-SHA-1'",
2);this._clientFirstMessageBare="n="+this.username.replace(/=/g,"=3D").replace(/,/g,"=2C")+",r="+JSJaCUtils.cnonce(16);var a;a=this.authzid?"n,a="+this.authzid.replace(/=/g,"=3D").replace(/,/g,"=2C")+",":"n,,";return this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='SCRAM-SHA-1'>"+b64encode(a+this._clientFirstMessageBare)+"</auth>",this._doSASLAuthScramSha1S1)}if(this.mechs["DIGEST-MD5"])return this.oDbg.log("SASL using mechanism 'DIGEST-MD5'",2),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='DIGEST-MD5'/>",
this._doSASLAuthDigestMd5S1);if(this._allow_plain&&this.mechs.PLAIN)return this.oDbg.log("SASL using mechanism 'PLAIN'",2),a=this.authzid+String.fromCharCode(0)+this.username+String.fromCharCode(0)+this.pass,this.oDbg.log("authenticating with '"+a+"'",2),a=b64encode(a),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='PLAIN'>"+a+"</auth>",this._doSASLAuthDone);this.oDbg.log("No SASL mechanism applied",1);this.authtype="nonsasl"}return!1};
JSJaCConnection.prototype._doSASLAuthScramSha1S1=function(a){if("challenge"!=a.nodeName)this.oDbg.log("challenge missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{a=b64decode(a.firstChild.nodeValue);this.oDbg.log("got challenge: "+a,2);var b={},c=a.split(","),d;for(d in c){var e=c[d].substring(2);b[c[d].substring(0,1)]=e}d=str2rstr_utf8(this.pass);for(var c=b64decode_bin(b.s)+"\x00\x00\x00\u0001",f,e=parseInt(b.i,10),g=0;g<e;g++)c=rstr_hmac_sha1(d,
c),f=JSJaCUtils.xor(f,c);d=this.authzid?"n,a="+this.authzid.replace(/=/g,"=3D").replace(/,/g,"=2C")+",":"n,,";b="c="+b64encode(d)+",r="+b.r;this._saltedPassword=f;f=rstr_hmac_sha1(this._saltedPassword,"Client Key");d=rstr_sha1(f);this._authMessage=this._clientFirstMessageBare+","+a+","+b;a=rstr_hmac_sha1(d,str2rstr_utf8(this._authMessage));a=JSJaCUtils.xor(f,a);a=b+",p="+rstr2b64(a);this.oDbg.log("response: "+a,2);this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>"+b64encode(a)+"</response>",
this._doSASLAuthScramSha1S2)}};
JSJaCConnection.prototype._doSASLAuthScramSha1S2=function(a){if("success"!=a.nodeName)this.oDbg.log("auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var b=b64decode(a.firstChild.nodeValue);this.oDbg.log("got success: "+b,2);a={};var b=b.split(","),c;for(c in b){var d=b[c].substring(2);a[b[c].substring(0,1)]=d}c=rstr_hmac_sha1(this._saltedPassword,"Server Key");c=rstr_hmac_sha1(c,str2rstr_utf8(this._authMessage));a=b64decode_bin(a.v);c!==
a?(this.oDbg.log("server auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()):this._reInitStream(JSJaC.bind(this._doStreamBind,this))}};
JSJaCConnection.prototype._doSASLAuthDigestMd5S1=function(a){if("challenge"!=a.nodeName)this.oDbg.log("challenge missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{a=b64decode(a.firstChild.nodeValue);var b;this.oDbg.log("got challenge: "+a,2);b=a.indexOf('nonce="');-1!==b?(this._nonce=a.substring(b+7),this._nonce=this._nonce.substring(0,this._nonce.indexOf('"')),this.oDbg.log("nonce: "+this._nonce,2),b=a.indexOf('realm="'),-1!==b&&(this._realm=
a.substring(b+7),this._realm=this._realm.substring(0,this._realm.indexOf('"'))),this._realm=this._realm||this.domain,this.oDbg.log("realm: "+this._realm,2),this._digest_uri="xmpp/"+this.domain,this._cnonce=JSJaCUtils.cnonce(14),this._nc="00000001",a=rstr_md5(str2rstr_utf8(this.username+":"+this._realm+":"+this.pass))+":"+this._nonce+":"+this._cnonce,this.authzid&&(a=a+":"+this.authzid),a=rstr2hex(rstr_md5(a)),b=hex_md5("AUTHENTICATE:"+this._digest_uri),a=hex_md5(a+":"+this._nonce+":"+this._nc+":"+
this._cnonce+":auth:"+b),a='username="'+this.username+'",realm="'+this._realm+'",nonce="'+this._nonce+'",cnonce="'+this._cnonce+'",nc='+this._nc+',qop=auth,digest-uri="'+this._digest_uri+'",response='+a+",charset=utf-8",this.authzid&&(a='authzid="'+this.authzid+'",'+a),this.oDbg.log("response: "+a,2),this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>"+b64encode(a)+"</response>",this._doSASLAuthDigestMd5S2)):(this.oDbg.log("no valid nonce found, aborting",1),this.disconnect())}};
JSJaCConnection.prototype._doSASLAuthDigestMd5S2=function(a){if("failure"==a.nodeName)a.xml?this.oDbg.log("auth error: "+a.xml,1):this.oDbg.log("auth error",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var b=b64decode(a.firstChild.nodeValue);this.oDbg.log("response: "+b,2);b=b.substring(b.indexOf("rspauth=")+8);this.oDbg.log("rspauth: "+b,2);var c=rstr_md5(str2rstr_utf8(this.username+":"+this._realm+":"+this.pass))+":"+this._nonce+":"+this._cnonce;
this.authzid&&(c=c+":"+this.authzid);var c=rstr2hex(rstr_md5(c)),d=hex_md5(":"+this._digest_uri),c=hex_md5(c+":"+this._nonce+":"+this._nc+":"+this._cnonce+":auth:"+d);this.oDbg.log("rsptest: "+c,2);c!=b?(this.oDbg.log("SASL Digest-MD5: server repsonse with wrong rspauth",1),this.disconnect()):"success"==a.nodeName?this._reInitStream(JSJaC.bind(this._doStreamBind,this)):this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'/>",this._doSASLAuthDone)}};
JSJaCConnection.prototype._doSASLAuthDone=function(a){"success"!=a.nodeName?(this.oDbg.log("auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()):this._reInitStream(JSJaC.bind(this._doStreamBind,this))};JSJaCConnection.prototype._doStreamBind=function(){var a=new JSJaCIQ;a.setIQ(null,"set","bind_1");a.appendNode("bind",{xmlns:NS_BIND},[["resource",this.resource]]);this.oDbg.log(a.xml());this.send(a,this._doXMPPSess)};
JSJaCConnection.prototype._doXMPPSess=function(a){"result"!=a.getType()||"error"==a.getType()?(this.disconnect(),"error"==a.getType()&&this._handleEvent("onerror",a.getChild("error"))):(this.fulljid=a.getChildVal("jid"),this.jid=this.fulljid.substring(0,this.fulljid.lastIndexOf("/")),a=new JSJaCIQ,a.setIQ(null,"set","sess_1"),a.appendNode("session",{xmlns:NS_SESSION},[]),this.oDbg.log(a.xml()),this.send(a,this._doXMPPSessDone))};
JSJaCConnection.prototype._doXMPPSessDone=function(a){"result"!=a.getType()||"error"==a.getType()?(this.disconnect(),"error"==a.getType()&&this._handleEvent("onerror",a.getChild("error"))):this._handleEvent("onconnect")};
JSJaCConnection.prototype._handleEvent=function(a,b){a=a.toLowerCase();this.oDbg.log("incoming event '"+a+"'",3);if(this._events[a]){this.oDbg.log("handling event '"+a+"'",2);for(var c=0;c<this._events[a].length;c++){var d=this._events[a][c];if("function"==typeof d.handler)if(b){if(b.pType){if(!b.getNode().hasChildNodes()&&"*"!=d.childName||b.getNode().hasChildNodes()&&!b.getChild(d.childName,d.childNS))continue;if("*"!=d.type&&b.getType()!=d.type)continue;this.oDbg.log(d.childName+"/"+d.childNS+
"/"+d.type+" => match for handler "+d.handler,3)}if(d.handler(b))break}else if(d.handler())break}}};
JSJaCConnection.prototype._handlePID=function(a){if(!a.getID())return!1;var b=a.getFrom()||this.jid,c=a.getFrom()&&a.getFromJID()&&a.getFromJID().getBareJID()?a.getFromJID().getBareJID():this.jid;a.getFrom()==this.domain&&(b=this.jid);var d=a.getID(),e=null;this._regIDs[b]&&this._regIDs[b][d]&&(e=this._regIDs[b][d]);!e&&(c&&this._regIDs[c]&&this._regIDs[c][d])&&(e=this._regIDs[c][d]);if(e){this.oDbg.log("handling id "+d,3);if(!1===e.cb.call(this,a,e.arg))return!1;delete this._regIDs[b][d];return!0}this.oDbg.log("not handling id '"+
d+"' from jid "+b,1);return!1};JSJaCConnection.prototype._handleResponse=function(a){if(a=this._parseResponse(a))for(var b=0;b<a.childNodes.length;b++)if(this._sendRawCallbacks.length){var c=this._sendRawCallbacks[0];this._sendRawCallbacks=this._sendRawCallbacks.slice(1,this._sendRawCallbacks.length);c.fn.call(this,a.childNodes.item(b),c.arg)}else this._inQ=this._inQ.concat(a.childNodes.item(b))};
JSJaCConnection.prototype._parseStreamFeatures=function(a){if(!a)return this.oDbg.log("nothing to parse ... aborting",1),!1;var b,c;if(a.getElementsByTagNameNS)b=a.getElementsByTagNameNS(NS_STREAM,"error").item(0);else{var d=a.getElementsByTagName("error");for(c=0;c<d.length;c++)if(d.item(c).namespaceURI==NS_STREAM||d.item(c).getAttribute("xmlns")==NS_STREAM){b=d.item(c);break}}if(b)return this._setStatus("internal_server_error"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),
this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),!1;this.mechs={};a=a.getElementsByTagName("mechanisms");if(!a.length)return!1;this.has_sasl=!1;for(c=0;c<a.length;c++)if(a.item(c).getAttribute("xmlns")==NS_SASL){this.has_sasl=!0;c=a.item(c).getElementsByTagName("mechanism");for(a=0;a<c.length;a++)this.mechs[c.item(a).firstChild.nodeValue]=!0;break}this.has_sasl?this.oDbg.log("SASL detected",
2):this.oDbg.log("No support for SASL detected",2);return!0};
JSJaCConnection.prototype._process=function(a){if(this.connected()){this.setPollInterval(a);this._timeout&&clearTimeout(this._timeout);var b=this._getFreeSlot();if(!(0>b))if("undefined"!=typeof this._req[b]&&"undefined"!=typeof this._req[b].r&&4!=this._req[b].r.readyState)this.oDbg.log("Slot "+b+" is not ready");else if(!this.isPolling()&&0===this._pQueue.length&&this._req[(b+1)%2]&&4!=this._req[(b+1)%2].r.readyState)this.oDbg.log("all slots busy, standby ...",2);else{this.isPolling()||this.oDbg.log("Found working slot at "+
b,2);this._req[b]=this._setupRequest(!0);this._req[b].r.onreadystatechange=JSJaC.bind(function(){this.connected()&&4==this._req[b].r.readyState&&(this.oDbg.log("async recv: "+this._req[b].r.responseText,4),this._handleResponse(this._req[b]),this._setStatus("processing"),this._pQueue.length?this._timeout=setTimeout(JSJaC.bind(this._process,this),100):(this.oDbg.log("scheduling next poll in "+this.getPollInterval()+" msec",4),this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval())))},
this);try{this._req[b].r.onerror=JSJaC.bind(function(){this.connected()&&(this._errcnt++,this.oDbg.log("XmlHttpRequest error ("+this._errcnt+")",1),this._errcnt>JSJAC_ERR_COUNT?this._abort():(this._setStatus("onerror_fallback"),setTimeout(JSJaC.bind(this._repeat,this),JSJAC_RETRYDELAY)))},this)}catch(c){}a=this._getRequestString();"undefined"!=typeof this._rid&&(this._req[b].rid=this._rid);this.oDbg.log("sending: "+a,4);this._req[b].r.send(a)}}else this.oDbg.log("Connection lost ...",1),this._interval&&
clearInterval(this._interval)};
JSJaCConnection.prototype._registerPID=function(a,b,c){this.oDbg.log("registering id for packet "+a.xml(),3);var d=a.getID();if(!d)return this.oDbg.log("id missing",1),!1;if("function"!=typeof b)return this.oDbg.log("callback is not a function",1),!1;var e=a.getTo()||this.jid;a.getTo()==this.domain&&(e=this.jid);this._regIDs[e]||(this._regIDs[e]={});if(null!=this._regIDs[e][d])return this.oDbg.log("id already registered: "+d,1),!1;this._regIDs[e][d]={cb:b,arg:c,ts:JSJaCUtils.now()};this.oDbg.log("registered id "+
d,3);this._cleanupRegisteredPIDs();return!0};JSJaCConnection.prototype._cleanupRegisteredPIDs=function(){var a=Date.now(),b;for(b in this._regIDs)if(this._regIDs.hasOwnProperty(b))for(var c in this._regIDs[b])this._regIDs[b].hasOwnProperty(c)&&this._regIDs[b][c].ts+JSJAC_REGID_TIMEOUT<a&&(this.oDbg.log("deleting registered id '"+c+"' due to timeout",1),delete this._regIDs[b][c])};JSJaCConnection.prototype._prepSendEmpty=function(a,b){return function(){b._sendEmpty(JSJaC.bind(a,b))}};
JSJaCConnection.prototype._sendEmpty=function(a){var b=this._getFreeSlot();this._req[b]=this._setupRequest(!0);this._req[b].r.onreadystatechange=JSJaC.bind(function(){4==this._req[b].r.readyState&&(this.oDbg.log("async recv: "+this._req[b].r.responseText,4),a(this._req[b].r))},this);"undefined"!=typeof this._req[b].r.onerror&&(this._req[b].r.onerror=JSJaC.bind(function(){this.oDbg.log("XmlHttpRequest error",1)},this));var c=this._getRequestString();this.oDbg.log("sending: "+c,4);this._req[b].r.send(c)};
JSJaCConnection.prototype._sendRaw=function(a,b,c){b&&this._sendRawCallbacks.push({fn:b,arg:c});this._pQueue.push(a);this._process();return!0};JSJaCConnection.prototype._setStatus=function(a){a&&""!==a&&a!=this._status&&(this._status=a,this._handleEvent("onstatuschanged",a),this._handleEvent("status_changed",a))};
function JSJaCHttpBindingConnection(a){this.base=JSJaCConnection;this.base(a);this._hold=JSJACHBC_MAX_HOLD;this._inactivity=0;this._last_requests={};this._pause=this._min_polling=this._last_rid=0;this._wait=a.wait||JSJACHBC_MAX_WAIT}JSJaCHttpBindingConnection.prototype=new JSJaCConnection;
JSJaCHttpBindingConnection.prototype.inherit=function(a){if(a.jid){var b=new JSJaCJID(a.jid);this.domain=b.getDomain();this.username=b.getNode();this.resource=b.getResource()}else this.domain=a.domain||"localhost",this.username=a.username,this.resource=a.resource;this._sid=a.sid;this._rid=a.rid;this._min_polling=a.polling;this._inactivity=a.inactivity;this._setHold(a.requests-1);this.setPollInterval(this._timerval);a.wait&&(this._wait=a.wait);this._connected=!0;this._handleEvent("onconnect");this._interval=
setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL);this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL);this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval())};JSJaCHttpBindingConnection.prototype.setPollInterval=function(a){a&&!isNaN(a)&&(this.isPolling()?this._timerval=this._min_polling&&a<1E3*this._min_polling?1E3*this._min_polling:this._inactivity&&a>1E3*this._inactivity?1E3*this._inactivity:a:this._timerval=100);return this._timerval};
JSJaCHttpBindingConnection.prototype.isPolling=function(){return 0===this._hold};JSJaCHttpBindingConnection.prototype._getFreeSlot=function(){for(var a=0;a<this._hold+1;a++)if("undefined"==typeof this._req[a]||"undefined"==typeof this._req[a].r||4==this._req[a].r.readyState)return a;return-1};JSJaCHttpBindingConnection.prototype._getHold=function(){return this._hold};
JSJaCHttpBindingConnection.prototype._getRequestString=function(a,b){a=a||"";var c="";if(this._rid<=this._last_rid&&"undefined"!=typeof this._last_requests[this._rid])c=this._last_requests[this._rid].xml;else{for(var d="";this._pQueue.length;)d+=this._pQueue[0],this._pQueue=this._pQueue.slice(1,this._pQueue.length);c="<body rid='"+this._rid+"' sid='"+this._sid+"' xmlns='http://jabber.org/protocol/httpbind'";JSJAC_HAVEKEYS&&(c+=" key='"+this._keys.getKey()+"'",this._keys.lastKey()&&(this._keys=new JSJaCKeys(hex_sha1,
this.oDbg),c+=" newkey='"+this._keys.getKey()+"'"));b?c+=" type='terminate'":this._reinit&&(JSJACHBC_USE_BOSH_VER&&(c+=" xml:lang='"+this._xmllang+"' xmpp:restart='true' xmlns:xmpp='urn:xmpp:xbosh' to='"+this.domain+"'"),this._reinit=!1);c=""!==d||""!==a?c+(">"+a+d+"</body>"):c+"/>";this._last_requests[this._rid]={};this._last_requests[this._rid].xml=c;this._last_rid=this._rid;for(var e in this._last_requests)this._last_requests.hasOwnProperty(e)&&e<this._rid-this._hold&&delete this._last_requests[e]}return c};
JSJaCHttpBindingConnection.prototype._getInitialRequestString=function(){var a="<body content='text/xml; charset=utf-8' hold='"+this._hold+"' xmlns='http://jabber.org/protocol/httpbind' to='"+this.authhost+"' wait='"+this._wait+"' rid='"+this._rid+"'";this.host&&this.port&&(a+=" route='xmpp:"+this.host+":"+this.port+"'");if(JSJAC_HAVEKEYS){this._keys=new JSJaCKeys(hex_sha1,this.oDbg);var b=this._keys.getKey(),a=a+(" newkey='"+b+"'")}a+=" xml:lang='"+this._xmllang+"'";if(JSJACHBC_USE_BOSH_VER&&(a+=
" ver='"+JSJACHBC_BOSH_VERSION+"'",a+=" xmlns:xmpp='urn:xmpp:xbosh'","sasl"==this.authtype||"saslanon"==this.authtype))a+=" xmpp:version='1.0'";return a+"/>"};
JSJaCHttpBindingConnection.prototype._getStreamID=function(a){this.oDbg.log(a.responseText,4);!a.responseXML||!a.responseXML.documentElement?this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")):(a=a.responseXML.documentElement,"terminate"==a.getAttribute("type")?this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")):(a.getAttribute("authid")&&(this.streamid=a.getAttribute("authid"),this.oDbg.log("got streamid: "+this.streamid,2)),this._parseStreamFeatures(a)?
(this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval()),this.register?this._doInBandReg():this._doAuth()):this._sendEmpty(JSJaC.bind(this._getStreamID,this))))};JSJaCHttpBindingConnection.prototype._getSuspendVars=function(){return"host port _rid _last_rid _wait _min_polling _inactivity _hold _last_requests _pause".split(" ")};
JSJaCHttpBindingConnection.prototype._handleInitialResponse=function(a){try{this.oDbg.log(a.getAllResponseHeaders(),4),this.oDbg.log(a.responseText,4)}catch(b){this.oDbg.log("No response",4)}if(200!=a.status||!a.responseXML)this.oDbg.log("initial response broken (status: "+a.status+")",1),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));else{var c=a.responseXML.documentElement;!c||"body"!=c.tagName||c.namespaceURI!=NS_BOSH?(this.oDbg.log("no body element or incorrect body in initial response",
1),this._handleEvent("onerror",JSJaCError("500","wait","internal-service-error"))):"terminate"==c.getAttribute("type")?(this.oDbg.log("invalid response:\n"+a.responseText,1),clearTimeout(this._timeout),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))):(this._sid=c.getAttribute("sid"),this.oDbg.log("got sid: "+this._sid,2),c.getAttribute("polling")&&(this._min_polling=c.getAttribute("polling")),
c.getAttribute("inactivity")&&(this._inactivity=c.getAttribute("inactivity")),c.getAttribute("requests")&&this._setHold(c.getAttribute("requests")-1),this.oDbg.log("set hold to "+this._getHold(),2),c.getAttribute("ver")&&(this._bosh_version=c.getAttribute("ver")),c.getAttribute("maxpause")&&(this._pause=Number.min(c.getAttribute("maxpause"),JSJACHBC_MAXPAUSE)),this.setPollInterval(this._timerval),this._connected=!0,this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL),
this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._getStreamID(a))}};
JSJaCHttpBindingConnection.prototype._parseResponse=function(a){if(!this.connected()||!a)return null;var b=a.r;try{if(404==b.status||403==b.status)return this._abort(),null;if(200!=b.status||!b.responseXML){this._errcnt++;var c="invalid response ("+b.status+"):\n"+b.getAllResponseHeaders()+"\n"+b.responseText;b.responseXML||(c+="\nResponse failed to parse!");this.oDbg.log(c,1);if(this._errcnt>JSJAC_ERR_COUNT)return this._abort(),null;this.connected()&&(this.oDbg.log("repeating ("+this._errcnt+")",
1),this._setStatus("proto_error_fallback"),setTimeout(JSJaC.bind(this._repeat,this),this.getPollInterval()));return null}}catch(d){return this.oDbg.log("XMLHttpRequest error: status not available",1),this._errcnt++,this._errcnt>JSJAC_ERR_COUNT?this._abort():this.connected()&&(this.oDbg.log("repeating ("+this._errcnt+")",1),this._setStatus("proto_error_fallback"),setTimeout(JSJaC.bind(this._repeat,this),this.getPollInterval())),null}c=b.responseXML.documentElement;if(!c||"body"!=c.tagName||c.namespaceURI!=
NS_BOSH)return this.oDbg.log("invalid response:\n"+b.responseText,1),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._setStatus("internal_server_error"),this._handleEvent("onerror",JSJaCError("500","wait","internal-server-error")),null;if("undefined"!=typeof a.rid&&this._last_requests[a.rid]){if(this._last_requests[a.rid].handled)return this.oDbg.log("already handled "+a.rid,
2),null;this._last_requests[a.rid].handled=!0}if("terminate"==c.getAttribute("type")){var e=c.getAttribute("condition");this.oDbg.log("session terminated:\n"+b.responseText,1);clearTimeout(this._timeout);clearInterval(this._interval);clearInterval(this._inQto);try{JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase()}catch(f){}this._connected=!1;"remote-stream-error"==e?0<c.getElementsByTagName("conflict").length?this._setStatus("session-terminate-conflict"):this._setStatus("terminated"):this._setStatus("terminated");
null===e&&(e="session-terminate");this._handleEvent("onerror",JSJaCError("503","cancel",e));this.oDbg.log("Aborting remaining connections",4);for(b=0;b<this._hold+1;b++)try{this._req[b]&&this._req[b]!=a&&this._req[b].r.abort()}catch(g){this.oDbg.log(g,1)}this.oDbg.log("parseResponse done with terminating",3);this.oDbg.log("Disconnected.",1);this._handleEvent("ondisconnect");return null}this._errcnt=0;return b.responseXML.documentElement};
JSJaCHttpBindingConnection.prototype._reInitStream=function(a){this._reinit=!0;this._sendEmpty(this._prepReInitStreamWait(a))};JSJaCHttpBindingConnection.prototype._prepReInitStreamWait=function(a){return JSJaC.bind(function(b){this._reInitStreamWait(b,a)},this)};
JSJaCHttpBindingConnection.prototype._reInitStreamWait=function(a,b){this.oDbg.log("checking for stream features");var c=a.responseXML.documentElement,d,e;this.oDbg.log(c);if(c.getElementsByTagNameNS)this.oDbg.log("checking with namespace"),(d=c.getElementsByTagNameNS(NS_STREAM,"features").item(0))&&(e=d.getElementsByTagNameNS(NS_BIND,"bind").item(0));else{var c=c.getElementsByTagName("stream:features"),f,g;f=0;for(g=c.length;f<g;f++)if(c.item(f).namespaceURI==NS_STREAM||c.item(f).getAttribute("xmlns")==
NS_STREAM){d=c.item(f);break}if(d){e=d.getElementsByTagName("bind");f=0;for(g=e.length;f<g;f++)if(e.item(f).namespaceURI==NS_BIND||e.item(f).getAttribute("xmlns")==NS_BIND){e=e.item(f);break}}}this.oDbg.log(d);this.oDbg.log(e);d?e?b():(this.oDbg.log("no bind feature - giving up",1),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect")):this._sendEmpty(this._prepReInitStreamWait(b))};
JSJaCHttpBindingConnection.prototype._repeat=function(){this._rid>=this._last_rid&&(this._rid=this._last_rid-1);this._process()};JSJaCHttpBindingConnection.prototype._resume=function(){0===this._pause?this._repeat():this._process()};JSJaCHttpBindingConnection.prototype._setHold=function(a){!a||isNaN(a)||0>a?a=0:a>JSJACHBC_MAX_HOLD&&(a=JSJACHBC_MAX_HOLD);return this._hold=a};
JSJaCHttpBindingConnection.prototype._setupRequest=function(a){var b={},c=XmlHttp.create();try{c.open("POST",this._httpbase,a),c.setRequestHeader("Content-Type","text/xml; charset=utf-8")}catch(d){this.oDbg.log(d,1)}b.r=c;this._rid++;b.rid=this._rid;return b};
JSJaCHttpBindingConnection.prototype._suspend=function(){if(0!==this._pause){var a=this._getFreeSlot();this._req[a]=this._setupRequest(!1);var b="<body pause='"+this._pause+"' xmlns='http://jabber.org/protocol/httpbind' sid='"+this._sid+"' rid='"+this._rid+"'";JSJAC_HAVEKEYS&&(b+=" key='"+this._keys.getKey()+"'",this._keys.lastKey()&&(this._keys=new JSJaCKeys(hex_sha1,this.oDbg),b+=" newkey='"+this._keys.getKey()+"'"));for(b+=">";this._pQueue.length;)b+=this._pQueue[0],this._pQueue=this._pQueue.slice(1,
this._pQueue.length);b+="</body>";this.oDbg.log("Disconnecting: "+b,4);this._req[a].r.send(b)}};function JSJaCWebSocketConnection(a){this.base=JSJaCConnection;this.base(a);this._ws=null;this.registerHandler("onerror",JSJaC.bind(this._cleanupWebSocket,this))}JSJaCWebSocketConnection.prototype=new JSJaCConnection;
JSJaCWebSocketConnection.prototype._cleanupWebSocket=function(){null!==this._ws&&(this._ws.onclose=null,this._ws.onerror=null,this._ws.onopen=null,this._ws.onmessage=null,this._ws.close(),this._ws=null)};
JSJaCWebSocketConnection.prototype.connect=function(a){this._setStatus("connecting");this.domain=a.domain||"localhost";this.username=a.username;this.resource=a.resource;this.pass=a.password||a.pass;this.authzid=a.authzid||"";this.register=a.register;this.authhost=a.authhost||this.domain;this.authtype=a.authtype||"sasl";this.jid=this.username+"@"+this.domain;this.fulljid=this.jid+"/"+this.resource;this._allow_plain=a.allow_plain?a.allow_plain:JSJAC_ALLOW_PLAIN;this._allow_scram=a.allow_scram?a.allow_scram:
JSJAC_ALLOW_SCRAM;this._xmllang=a.xmllang&&""!==a.xmllang?a.xmllang:"en";"undefined"===typeof WebSocket?this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")):(this._ws=new WebSocket(this._httpbase,"xmpp"),this._ws.onclose=JSJaC.bind(this._onclose,this),this._ws.onerror=JSJaC.bind(this._onerror,this),this._ws.onopen=JSJaC.bind(this._onopen,this))};
JSJaCWebSocketConnection.prototype._onopen=function(){var a=this._getInitialRequestString();this.oDbg.log(a,4);this._ws.onmessage=JSJaC.bind(this._handleOpenStream,this);this._ws.send(a)};
JSJaCWebSocketConnection.prototype._handleOpenStream=function(a){this.oDbg.log(a.data,4);a=a.data;a=a.substr(a.indexOf("<stream:stream"));"/>"!==a.substr(-2)&&"</stream:stream>"!==a.substr(-16)&&(a+="</stream:stream>");(a=this._parseXml(a))?(this.streamid=a.getAttribute("id"),this.oDbg.log("got streamid: "+this.streamid,2),this._ws.onmessage=JSJaC.bind(this._handleInitialResponse,this)):this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))};
JSJaCWebSocketConnection.prototype._handleInitialResponse=function(a){a=this._parseXml(a.data);this._parseStreamFeatures(a)?(this._connected=!0,this.register?this._doInBandReg():this._doAuth()):this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))};
JSJaCWebSocketConnection.prototype.disconnect=function(){this._setStatus("disconnecting");this.connected()&&(this._connected=!1,this.oDbg.log("Disconnecting",4),this._sendRaw("</stream:stream>",JSJaC.bind(this._cleanupWebSocket,this)),this.oDbg.log("Disconnected",2),this._handleEvent("ondisconnect"))};JSJaCWebSocketConnection.prototype._onclose=function(){this.oDbg.log("websocket closed",2);"disconnecting"!==this._status&&(this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")))};
JSJaCWebSocketConnection.prototype._onerror=function(){this.oDbg.log("websocket error",1);this._connected=!1;this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))};
JSJaCWebSocketConnection.prototype._onmessage=function(a){var b;b=a.data;this._setStatus("processing");if(b&&""!==b)if(b=this._parseXml(b),b.namespaceURI===NS_STREAM&&"error"===b.localName)0<b.getElementsByTagNameNS(NS_STREAMS,"conflict").length&&this._setStatus("session-terminate-conflict"),this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","remote-stream-error"));else if(b=JSJaCPacket.wrapNode(b))this.oDbg.log("async recv: "+a.data,4),this._handleEvent("packet_in",b),b.pType&&
!this._handlePID(b)&&(this._handleEvent(b.pType()+"_in",b),this._handleEvent(b.pType(),b))};
JSJaCWebSocketConnection.prototype._parseXml=function(a){var b;this.oDbg.log("Parsing: "+a,4);try{if(b=XmlDocument.create("stream",NS_STREAM),"</stream:stream>"==a.trim()){this.oDbg.log("session terminated",1);clearTimeout(this._timeout);clearInterval(this._interval);clearInterval(this._inQto);try{JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase()}catch(c){}this._connected=!1;this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate"));this.oDbg.log("Disconnected.",1);this._handleEvent("ondisconnect")}else{if(-1===
a.indexOf("<stream:stream"))return b.loadXML("<stream:stream xmlns:stream='"+NS_STREAM+"' xmlns='jabber:client'>"+a+"</stream:stream>"),b.documentElement.firstChild;b.loadXML(a);return b.documentElement}}catch(d){this.oDbg.log("Error: "+d),this._connected=!1,this._handleEvent("onerror",JSJaCError("500","wait","internal-service-error"))}return null};
JSJaCWebSocketConnection.prototype._getInitialRequestString=function(){var a;a=this.domain;this.authhost&&(a=this.authhost);a='<stream:stream to="'+a+'" xmlns="jabber:client" xmlns:stream="'+NS_STREAM+'"';if("sasl"===this.authtype||"saslanon"===this.authtype)a+=' version="1.0"';return a+">"};
JSJaCWebSocketConnection.prototype.send=function(a,b,c){if(!this.connected())return!1;if(!a||!a.pType)return this.oDbg.log("no packet: "+a,1),!1;this._ws.onmessage=JSJaC.bind(this._onmessage,this);b&&(a.getID()||a.setID("JSJaCID_"+this._ID++),this._registerPID(a,b,c));try{this._handleEvent(a.pType()+"_out",a),this._handleEvent("packet_out",a),this._ws.send(a.xml())}catch(d){return this.oDbg.log(d.toString(),1),!1}return!0};JSJaCWebSocketConnection.prototype.resume=function(){return!1};
JSJaCWebSocketConnection.prototype.suspend=function(){return!1};JSJaCWebSocketConnection.prototype._doSASLAuthScramSha1S1=function(a){a=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthScramSha1S1,this)(a)};JSJaCWebSocketConnection.prototype._doSASLAuthScramSha1S2=function(a){a=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthScramSha1S2,this)(a)};
JSJaCWebSocketConnection.prototype._doSASLAuthDigestMd5S1=function(a){a=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDigestMd5S1,this)(a)};JSJaCWebSocketConnection.prototype._doSASLAuthDigestMd5S2=function(a){a=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDigestMd5S2,this)(a)};JSJaCWebSocketConnection.prototype._doSASLAuthDone=function(a){a=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDone,this)(a)};
JSJaCWebSocketConnection.prototype._reInitStream=function(a){var b=this.domain;this.authhost&&(b=this.authhost);this._sendRaw('<stream:stream xmlns:stream="'+NS_STREAM+'" xmlns="jabber:client" to="'+b+'" version="1.0">',a)};JSJaCWebSocketConnection.prototype._sendRaw=function(a,b,c){if(!this._ws)return!1;b&&(this._ws.onmessage=JSJaC.bind(b,this,c));this._ws.send(a);return!0};
var JSJaC={Version:"1.4",require:function(a){document.write('<script type="text/javascript" src="'+a+'">\x3c/script>')},load:function(){var a="xmlextras jsextras crypt JSJaCConfig JSJaCConstants JSJaCCookie JSJaCJSON JSJaCJID JSJaCUtils JSJaCBuilder JSJaCPacket JSJaCError JSJaCKeys JSJaCConnection JSJaCHttpPollingConnection JSJaCHttpBindingConnection JSJaCConsoleLogger JSJaCWebSocketConnection".split(" "),b=document.getElementsByTagName("script"),c="./",d;for(d=0;d<b.length;d++)if(b.item(d).src&&
b.item(d).src.match(/JSJaC\.js$/)){c=b.item(d).src.replace(/JSJaC.js$/,"");break}for(d=0;d<a.length;d++)this.require(c+a[d]+".js")},bind:function(a,b,c){return function(d){return a.apply(b,[d,c])}}};"undefined"==typeof JSJaCConnection&&JSJaC.load();function WTAPI(a,b,c){var d="",e="http:";0===c.indexOf("https://")&&(e="https:");d=c.replace(e+"//","").split("/")[0];this.server="wildix";this.extension=a;this.password=b;this.resource_prefix="wtapi";this.resource_postfix=Math.round(1E4*Math.random());this.resource=this._makeResource(a,b,this.resource_prefix,this.resource_postfix);this.jid=a+"@"+this.server;this.jid_full=this.jid+"/"+this.resource;this.sid=this._makeUniqueId(a,b,"wtapi");this.recon_time=0;this.recon_timeout=!1;this.recon_timeout_min=
2;this.recon_timeout_max=16;this.recon_timeout_skip=360;this.recon_inactivity=45;this.verify_time=!1;this.verify_timeout=1;this.con=!1;this.con_id=0;this.con_rid=!1;this.con_secs=0;this.con_url=c;this.host=d;this.protocol=e;this.con_errors=[];this.con_wait=30;this.con_debuger=null;this.con_props={httpbase:this.con_url,wait:this.con_wait,oDbg:this.con_debuger};this.connecting=this.connected=!1;this.handlers={};WTAPI.Observable.call(this);WTAPI.ajax.settings.host=this.host;WTAPI.ajax.settings.protocol=
this.protocol;for(a=0;a<this.plugins.length;a++)b=this.plugins[a],c=new b.cls(this),this[b.name]=c}WTAPI.Observable=function(){this._listeners={}};WTAPI.Observable.prototype.addListener=function(a,b,c){b={callback:b,scope:c||this};"undefined"===typeof this._listeners[a]?this._listeners[a]=[b]:this._listeners[a].push(b)};WTAPI.Observable.prototype.on=WTAPI.Observable.prototype.addListener;
WTAPI.Observable.prototype.removeListener=function(a,b){var c=this._listeners[a];if("undefined"!==typeof c){for(var d=[],e=0;e<c.length;e++)c[e].callback!=b&&d.push(c[e]);this._listeners[a]=d}};WTAPI.Observable.prototype._fire=function(a){var b=this._listeners[a],c=Array.prototype.slice.call(arguments,1,arguments.length);if("undefined"!==typeof b)for(var d=0;d<b.length;d++){var e=b[d];e.callback.apply(e.scope,c)}};WTAPI.prototype=Object.create(WTAPI.Observable.prototype);WTAPI.prototype.plugins=[];
WTAPI.addPlugin=function(a,b){WTAPI.prototype.plugins.push({name:a,cls:b})};
WTAPI.prototype.connect=function(){this.con_reconnect=!0;WTAPI.ajax({url:"/api/v1/personal/login",type:"POST",data:{login:this.extension,password:this.password},success:this._proxy(function(a,b,c){"result"==a.type&&"OK"==a.result&&this._getPersonalInfo()},this),error:this._proxy(function(a,b,c){if(404!=a.status){b=a.statusText;if(a&&a.responseText)try{var d=JSON.parse(a.responseText);d.type&&"error"==d.type&&(b=d.reason)}catch(e){}this._fire("disconnected",b)}else this._connect(),this._verify()},
this)})};
WTAPI.prototype._getPersonalInfo=function(){WTAPI.ajax({url:"/api/v1/personal/info",type:"GET",data:{fields:"extension,name,jid,password,email,login"},success:this._proxy(function(a,b,c){if("result"==a.type&&a.result){if(a.result.extension==this.extension||a.result.name==this.extension||a.result.email==this.extension||a.result.login==this.extension)this.extension=a.result.extension,a.result.hasOwnProperty("password")&&(this.password=a.result.password),this.resource=this._makeResource(this.extension,this.password,
this.resource_prefix,this.resource_postfix),this.jid=this.extension+"@"+this.server,this.jid_full=this.jid+"/"+this.resource,this.sid=this._makeUniqueId(this.extension,this.password,"wtapi");a.result.hasOwnProperty("jid")?this.extension==a.result.extension?(this.server=(new JSJaCJID(a.result.jid)).getDomain(),this.jid=a.result.jid,this.jid_full=this.jid+"/"+this.resource,this.con_props.httpbase=("http:"==this.protocol?"ws":"wss")+"://"+this.host+"/xmpp/",this._connect(!0)):this._fire("disconnected",
"Wrong data"):(this._connect(),this._verify())}},this),error:this._proxy(function(a,b,c){b=a.statusText;if(a&&a.responseText)try{var d=JSON.parse(a.responseText);d.type&&"error"==d.type&&(b=d.reason)}catch(e){}this._fire("disconnected",b)},this)})};
WTAPI.prototype._connect=function(a){this.con_id++;this.con=a?new JSJaCWebSocketConnection(this.con_props):new JSJaCHttpBindingConnection(this.con_props);this.con.registerHandler("onconnect",this._proxy(this._handleConnected,this));this.con.registerHandler("ondisconnect",this._proxy(this._handleDisconnected,this));this.con.registerHandler("onerror",this._proxy(this._handleConnectionError,this));this.con.registerHandler("presence",this._proxy(this._handlePresence,this));this.con.registerHandler("message",
this._proxy(this._handleMessage,this));this.con.registerHandler("iq",this._proxy(this._handleIQ,this));this.con.registerHandler("iq","ping","urn:xmpp:ping",this._proxy(this._handlePing,this));a={domain:this.server,username:this.extension,pass:this.password,resource:this.resource,register:!1};this.connecting=!0;try{this.con.connect(a)}catch(b){console.log(b)}};WTAPI.prototype.disconnect=function(){this.con_reconnect=!1;this._disconnect()};WTAPI.prototype._disconnect=function(){this.connected=!1;try{this.con.disconnect()}catch(a){this.con_errors.push(a)}};
WTAPI.prototype.isNewServer=function(){return"wildix"!=this.server};WTAPI.prototype.getConnection=function(){return this.con};WTAPI.prototype.isConnected=function(){return this.connected};WTAPI.prototype.registerHandler=function(a,b,c,d){b={callback:b,scope:c,priotiry:d};"undefined"===typeof this.handlers[a]?this.handlers[a]=[b]:(this.handlers[a].push(b),this.handlers[a].sort(this._priorityComparator))};
WTAPI.prototype.unregisterHandler=function(a,b){var c=this.handlers[a];if("undefined"!==typeof c){for(var d=[],e=0;e<c.length;e++)c[e].callback!=b&&d.push(c[e]);this.handlers[a]=d}};WTAPI.prototype.getExtension=function(){return this.extension};WTAPI.prototype.getJid=function(){return this.jid};WTAPI.prototype.getFullJid=function(){return this.jid_full};
WTAPI.prototype._execute=function(a,b){var c=this.handlers[a];if("undefined"!==typeof c)for(var d=0;d<c.length;d++){var e=c[d];if(e.callback.apply(e.scope,b))break}};WTAPI.prototype._handleConnected=function(){this.connecting=!1;this.connected=!0;this._fire("connected");var a=this.con_id;setTimeout(function(){a==this.con_id&&(this.recon_timeout=this.recon_time=!1)},1E3*this.recon_timeout_skip);var b=new JSJaCPresence;this.con.send(b)};
WTAPI.prototype._handleConnectionError=function(a){"503"==a.getAttribute("code")&&(a.firstChild&&"remote-stream-error"==a.firstChild.tagName)&&(this.resource_postfix=Math.round(1E4*Math.random()),this.resource=this._makeResource(this.extension,this.password,this.resource_prefix,this.resource_postfix),this.jid_full=this.jid+"/"+this.resource);this._connected||(this.con_errors.push(a),this._disconnect(),this._handleDisconnected());this.con_errors.push(a);this.connecting=!1};
WTAPI.prototype._handleDisconnected=function(){var a;0<this.con_errors.length&&(a=this.con_errors[0],a instanceof Node&&(a=document.createElement("div"),a.appendChild(this.con_errors[0]),a=a.innerHTML));this.connecting=this.connected=!1;this._fire("disconnected",a)};WTAPI.prototype._handlePresence=function(){this._execute("presence",arguments)};WTAPI.prototype._handleMessage=function(){this._execute("message",arguments)};WTAPI.prototype._handleIQ=function(){this._execute("iq",arguments)};
WTAPI.prototype._handlePing=function(a){var b=new JSJaCIQ;b.setTo(a.getFrom());b.setType("result");b.setID(a.getID());this.con.send(b)};
WTAPI.prototype._verify=function(){var a=Math.round((new Date).getTime()/1E3);this.con_reconnect&&(0<this.con_errors.length?(this.con_errors=[],this.recon_time=this.verify_timeout,this.recon_timeout=this._random(this.recon_timeout_min,this.recon_timeout_max)):!1==this.connected&&!1==this.connecting?this.recon_time?this.recon_time>=this.recon_timeout?this._connect():this.recon_time+=this.verify_timeout:this._connect():!0==this.connected&&(this.con_secs+=this.verify_timeout,this.con_rid!=this.con._rid?
(this.con_rid=this.con._rid,this.con_secs=0):this.con_secs>this.recon_inactivity&&(this.connected&&!this.connecting)&&(this.con_errors.push("Found this connection is not alive!"),this._disconnect()),this.verify_time&&(Math.abs(a-this.verify_time)>this.con_wait&&!this.connecting)&&(this.con_errors.push("Found this computer was in sleep mode"),this._disconnect())));this.verify_time=a;setTimeout(this._proxy(this._verify,this),1E3*this.verify_timeout)};
WTAPI.prototype._makeResource=function(a,b,c,d){b=a+"-"+b+"-"+window.location.protocol+"-"+navigator.userAgent;for(var e=352654597,f=e,g=0,k="";g<b.length;){e=(e<<5)+e+(e>>27)^b.charCodeAt(g);if(g==b.length-1)break;f=(f<<5)+f+(f>>27)^b.charCodeAt(g+1);g+=2}e=new String(e);f=new String(1566083941*f);k=c+"-"+a+"-"+e.substr(e.length-4,4)+"-"+f.substr(e.length-4,4);d&&(k=k+"-"+d);return k};
WTAPI.prototype._makeUniqueId=function(a,b,c){b=a+b+window.location.protocol+navigator.userAgent+Math.random();for(var d=352654597,e=d,f=0;f<b.length;){d=(d<<5)+d+(d>>27)^b.charCodeAt(f);if(f==b.length-1)break;e=(e<<5)+e+(e>>27)^b.charCodeAt(f+1);f+=2}d=new String(d);e=new String(1566083941*e);return c+"_"+a+"_"+d.substr(d.length-4,4)+"_"+e.substr(d.length-4,4)};WTAPI.prototype._random=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)};
WTAPI.prototype._proxy=function(a,b){return function(){a.apply(b,arguments)}};WTAPI.prototype._priorityComparator=function(a,b){return a.priotiry<b.priotiry?-1:a.priotiry>b.priotiry?1:0};WTAPI.User=function(a,b){this._id=WTAPI.User._id++;this._jid=a;this._name=b||null;this._group=null;var c=this._jid.split("@");if(1<c.length&&("172.16.0.6"==c[1]||"kite.wildix.com"==c[1]))this._group="Kite";this._extension=c[0]};WTAPI.User._id=1;WTAPI.User.prototype.getId=function(){return this._jid};
WTAPI.User.prototype.getJid=function(){return this._jid};WTAPI.User.prototype.getName=function(){return this._name};WTAPI.User.prototype.setName=function(a){this._name=a};WTAPI.User.prototype.getExtension=function(){return this._extension};WTAPI.User.prototype.isGroupExist=function(){return null!==this._group};WTAPI.User.prototype.getGroup=function(){return this._group};WTAPI.User.prototype.setGroup=function(a){this._group=a};WTAPI.ConnectedCall=function(a,b){this._name=a;this._number=b};
WTAPI.ConnectedCall.prototype.getName=function(){return this._name};WTAPI.ConnectedCall.prototype.getNumber=function(){return this._number};WTAPI.Location=function(a,b,c){this._address=a;this._lat=b;this._lng=c};WTAPI.Location.prototype.getAddress=function(){return this._address};WTAPI.Location.prototype.getLat=function(){return this._lat};WTAPI.Location.prototype.getLng=function(){return this._lng};
WTAPI.ProfileData=function(a,b,c,d,e,f,g){this._mail=a;this._authProvider=b;this._url=c;this._gender=d;this._language=e;this._parentHostUrl=f;this._photo=g};WTAPI.ProfileData.prototype.getMail=function(){return this._mail};WTAPI.ProfileData.prototype.getAuthProvider=function(){return this._authProvider};WTAPI.ProfileData.prototype.getUrl=function(){return this._url};WTAPI.ProfileData.prototype.getGender=function(){return this._gender};WTAPI.ProfileData.prototype.getLanguage=function(){return this._language};
WTAPI.ProfileData.prototype.getParentHostUrl=function(){return this._parentHostUrl};WTAPI.ProfileData.prototype.getPhoto=function(){return this._photo};WTAPI.Presence=function(){this._online=!1;this._deviceShow=this._show=WTAPI.Presence.NONE;this._connectedCall=this._until=this._profileData=this._location=this._status=null};WTAPI.Presence.NONE=0;WTAPI.Presence.AWAY=1;WTAPI.Presence.DND=2;WTAPI.Presence.RINGING=3;WTAPI.Presence.TALKING=4;WTAPI.Presence.RT=5;WTAPI.Presence.MUR=6;
WTAPI.Presence.REGISTERED=7;WTAPI.Presence.prototype.isOnline=function(){return this._online};WTAPI.Presence.prototype.isAway=function(){return this._show===WTAPI.Presence.AWAY};WTAPI.Presence.prototype.isDND=function(){return this._show===WTAPI.Presence.DND};WTAPI.Presence.prototype.isMUR=function(){return this._show===WTAPI.Presence.MUR};WTAPI.Presence.prototype.isRinging=function(){return this._deviceShow===WTAPI.Presence.RINGING||this._deviceShow===WTAPI.Presence.RT};
WTAPI.Presence.prototype.isTalking=function(){return this._deviceShow===WTAPI.Presence.TALKING||this._deviceShow===WTAPI.Presence.RT};WTAPI.Presence.prototype.isTalkingAndRinging=function(){return this._deviceShow===WTAPI.Presence.RT};WTAPI.Presence.prototype.isRegisteredDevice=function(){return this._deviceShow===WTAPI.Presence.REGISTERED};
WTAPI.Presence.prototype.isEmpty=function(){return this._show!==WTAPI.Presence.NONE||this._deviceShow!==WTAPI.Presence.NONE||null!==this._location||null!==this._profileData||null!==this._until||null!==this._status?!1:!0};
WTAPI.Presence.prototype.getStatusIcon=function(){switch(this._show){case WTAPI.Presence.AWAY:return this._online?"away":"away-offline";case WTAPI.Presence.DND:return this._online?"dnd":"dnd-offline";case WTAPI.Presence.MUR:return this._online?"mur":"mur-offline";default:return this._online?"online":"offline"}};WTAPI.Presence.prototype.getStatusMessage=function(){return this._status};WTAPI.Presence.prototype.isStatusMessageAvailable=function(){return null!==this._status};
WTAPI.Presence.prototype.getStatusUntil=function(){return this._until};WTAPI.Presence.prototype.isStatusUntilAvailable=function(){return null!==this._until};WTAPI.Presence.prototype.getConnectedCall=function(){return this._connectedCall};WTAPI.Presence.prototype.isConnectedCallAvailable=function(){return this._connectedCall instanceof WTAPI.ConnectedCall};WTAPI.Presence.prototype.getLocation=function(){return this._location};WTAPI.Presence.prototype.getProfileData=function(){return this._profileData};
WTAPI.Presence.prototype.isLocationAvailable=function(){return this._location instanceof WTAPI.Location};WTAPI.Presence.Builder=function(){var a=new WTAPI.Presence;this._getPresence=function(){return a}};WTAPI.Presence.Builder.prototype.setOnline=function(){this._getPresence()._online=!0;return this};WTAPI.Presence.Builder.prototype.setAway=function(){this._getPresence()._show=WTAPI.Presence.AWAY;return this};
WTAPI.Presence.Builder.prototype.setDND=function(){this._getPresence()._show=WTAPI.Presence.DND;return this};WTAPI.Presence.Builder.prototype.setMUR=function(){this._getPresence()._show=WTAPI.Presence.MUR;return this};WTAPI.Presence.Builder.prototype.setRinging=function(){this._getPresence()._deviceShow=WTAPI.Presence.RINGING;return this};WTAPI.Presence.Builder.prototype.setTalking=function(){this._getPresence()._deviceShow=WTAPI.Presence.TALKING;return this};
WTAPI.Presence.Builder.prototype.setRingingAndTalking=function(){this._getPresence()._deviceShow=WTAPI.Presence.RT;return this};WTAPI.Presence.Builder.prototype.setRegisteredDevice=function(){this._getPresence()._deviceShow=WTAPI.Presence.REGISTERED;return this};WTAPI.Presence.Builder.prototype.setStatusMessage=function(a){this._getPresence()._status=a;return this};WTAPI.Presence.Builder.prototype.setStatusUntil=function(a){this._getPresence()._until=a;return this};
WTAPI.Presence.Builder.prototype.setLocation=function(a){if(!(a instanceof WTAPI.Location))throw Error("Invalid location argument, it should be a WTAPI.Location instance");this._getPresence()._location=a;return this};WTAPI.Presence.Builder.prototype.setConnectedCall=function(a){if(!(a instanceof WTAPI.ConnectedCall))throw Error("Invalid call argument, it should be a WTAPI.ConnectedCall instance");this._getPresence()._connectedCall=a;return this};
WTAPI.Presence.Builder.prototype.setProfileData=function(a){if(!(a instanceof WTAPI.ProfileData))throw Error("Invalid profile data argument, it should be a WTAPI.ProfileData instance");this._getPresence()._profileData=a;return this};WTAPI.Presence.Builder.prototype.build=function(){return this._getPresence()};WTAPI.Message=function(){this._body=this._id=""};WTAPI.Message.prototype.getId=function(){return this._id};WTAPI.Message.prototype.getBody=function(){return this._body};
WTAPI.Message.Builder=function(){var a=new WTAPI.Message;return{withId:function(b){a._id=b;return this},withAutoGeneratedId:function(){a._id=this._rand()+this._rand()+"-"+this._rand()+"-"+this._rand()+"-"+this._rand()+"-"+this._rand()+this._rand()+this._rand();return this},withBody:function(b){a._body=b;return this},build:function(){return a},_rand:function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}}};(function(a){function b(a,b,c,e){if(a.global)return!0}function c(a){a.global&&0===t.active++&&b(a,null,"ajaxStart")}function d(a,c){var e=c.context;if(!1===c.beforeSend.call(e,a,c)||!1===b(c,e,"ajaxBeforeSend",[a,c]))return!1;b(c,e,"ajaxSend",[a,c])}function e(a,c,e){var d=e.context;e.success.call(d,a,"success",c);b(e,d,"ajaxSuccess",[c,e,a]);g("success",c,e)}function f(a,c,e,d){var f=d.context;d.error.call(f,e,c,a);b(d,f,"ajaxError",[e,d,a]);g(c,e,d)}function g(a,c,e){var d=e.context;e.complete.call(d,
c,a);b(e,d,"ajaxComplete",[c,e]);e.global&&!--t.active&&b(e,null,"ajaxStop")}function k(){}function h(a){return a&&(a==w?"html":a==x?"json":z.test(a)?"script":A.test(a)&&"xml")||"text"}function m(a){"object"===typeof a.data&&(a.data=n(a.data));if(a.data&&(!a.type||"GET"==a.type.toUpperCase()))a.url=(a.url+"&"+a.data).replace(/[&?]{1,2}/,"?")}function p(a,c,b,e){var d="array"===typeof c,g;for(g in c){var f=c[g];e&&(g=b?e:e+"["+(d?"":g)+"]");!e&&d?a.add(f.name,f.value):(b?"array"===typeof f:"object"===
typeof f)?p(a,f,b,g):a.add(g,f)}}function n(a,c){var b=[];b.add=function(a,c){this.push(y(a)+"="+y(c))};p(b,a,c);return b.join("&").replace("%20","+")}function l(a){Array.prototype.slice.call(arguments,1).forEach(function(c){for(s in c)void 0!==c[s]&&(a[s]=c[s])});return a}var u=0,q=window.document,s,v,z=/^(?:text|application)\/javascript/i,A=/^(?:text|application)\/xml/i,x="application/json; charset=utf-8",w="text/html",B=/^\s*$/,t=function(a){var b=l({},a||{});for(s in t.settings)void 0===b[s]&&
(b[s]=t.settings[s]);b.url=b.protocol+"//"+b.host+""+b.url;c(b);b.crossDomain||(b.crossDomain=/^([\w-]+:)?\/\/([^\/]+)/.test(b.url)&&RegExp.$2!=window.location.host);var g=b.dataType;a=/=\?/.test(b.url);if("jsonp"==g||a)return a||(b.url=(b.url+"&callback=?").replace(/[&?]{1,2}/,"?")),t.JSONP(b);b.url||(b.url=window.location.toString());m(b);a=b.accepts[g];var p={},n=/^([\w-]+:)\/\//.test(b.url)?RegExp.$1:window.location.protocol,r=t.settings.xhr(),q;if(b.xhrFields)for(i in b.xhrFields)r[i]=b.xhrFields[i];
b.crossDomain||(p["X-Requested-With"]="XMLHttpRequest");a&&(p.Accept=a,-1<a.indexOf(",")&&(a=a.split(",",2)[0]),r.overrideMimeType&&r.overrideMimeType(a));if(b.contentType||b.data&&"GET"!=b.type.toUpperCase())p["Content-Type"]=b.contentType||"application/x-www-form-urlencoded";b.headers=l(p,b.headers||{});r.onreadystatechange=function(){if(4==r.readyState){clearTimeout(q);var a,c=!1;if(200<=r.status&&300>r.status||304==r.status||0==r.status&&"file:"==n){g=g||h(r.getResponseHeader("content-type"));
a=r.responseText;try{if("script"==g)(0,eval)(a);else if("xml"==g)a=r.responseXML;else if("json"==g||"application/json"==response)a=B.test(a)?null:JSON.parse(a)}catch(d){c=d}c?f(c,"parsererror",r,b):e(a,r,b)}else f(null,"error",r,b)}};r.open(b.type,b.url,"async"in b?b.async:!0);for(v in b.headers)r.setRequestHeader(v,b.headers[v]);if(!1===d(r,b))return r.abort(),!1;0<b.timeout&&(q=setTimeout(function(){r.onreadystatechange=k;r.abort();f(null,"timeout",r,b)},b.timeout));r.send(b.data?b.data:null);return r};
t.active=0;t.JSONP=function(a){if(!("type"in a))return t(a);var b="jsonp"+ ++u,c=q.createElement("script"),d={abort:function(){b in window&&(window[b]=k);g("abort",d,a)}},f,h=q.getElementsByTagName("head")[0]||q.documentElement;a.error&&(c.onerror=function(){d.abort();a.error()});window[b]=function(c){clearTimeout(f);delete window[b];e(c,d,a)};m(a);c.src=a.url.replace(/=\?/,"="+b);h.insertBefore(c,h.firstChild);0<a.timeout&&(f=setTimeout(function(){d.abort();g("timeout",d,a)},a.timeout));return d};
t.settings={type:"GET",beforeSend:k,success:k,error:k,complete:k,context:null,global:!0,xhr:function(){return new window.XMLHttpRequest},accepts:{script:"text/javascript, application/javascript",json:x,xml:"application/xml, text/xml",html:w,text:"text/plain"},crossDomain:!0,xhrFields:{withCredentials:!0},timeout:0};t.get=function(a,b){return t({url:a,success:b})};t.post=function(a,b,c,e){"function"===typeof b&&(e=e||c,c=b,b=null);return t({type:"POST",url:a,data:b,success:c,dataType:e})};t.getJSON=
function(a,b){return t({url:a,success:b,dataType:"json"})};var y=encodeURIComponent;a.ajax=t})(WTAPI);(function(a){function b(b){this._users={};this._wtapi=b;this._wtapi.addListener("connected",this._onConnected,this);this._wtapi.addListener("disconnected",this._onDisconnected,this);this.roster=[];a.Observable.call(this)}b.prototype=Object.create(a.Observable.prototype);b.prototype.getUser=function(a){return a in this._users?this._users[a]:null};b.prototype.getUserByExtension=function(a){if(this._users)for(key in this._users)if(this._users[key].getExtension()==a)return this._users[key];return null};
b.prototype.getRoster=function(a,b){var e=b||this,f=this._createGetRosterPacket(),e=this._createGetRosterHandler(a,e);this._wtapi.getConnection().sendIQ(f,e)};b.prototype.createUser=function(b,d){return this._addUser(new a.User(b,d))};b.prototype.createUserByExtension=function(b){var d=b+"@wildix";this._wtapi.isNewServer()&&(d=b+"@"+this._wtapi.server);return this._addUser(new a.User(d,null))};b.prototype._addUser=function(a){if(a.getJid()in this._users)throw Error("User "+a.getJid()+" already exist");
return this._users[a.getJid()]=a};b.prototype._onConnected=function(){};b.prototype._onDisconnected=function(){};b.prototype._createGetRosterPacket=function(){var a=(new JSJaCIQ).setType("get");a.setQuery("jabber:iq:roster");return a};b.prototype._createGetRosterHandler=function(a,b){var e=this;return{result_handler:function(f){"function"==typeof a&&a.call(b,e._parseGetRosterResponse(f))},error_handler:function(){"function"==typeof a&&a.call(b,[])}}};b.prototype._parseGetRosterResponse=function(a){a=
a.getNode().getElementsByTagName("item");for(var b=[],e=0;e<a.length;e++){var f=a.item(e),g=f.getAttribute("jid"),k=f.getAttribute("name"),h,f=f.getElementsByTagName("group");0<f.length&&f.item(0).firstChild&&(h=f.item(0).firstChild.nodeValue);f=this.getUser(g);null===f&&(f=this.createUser(g,k));f.setGroup(h);f.setName(k);b.push(f)}return b};a.addPlugin("roster",b)})(WTAPI);(function(a){function b(b){this._calls=[];this._devices=[];this._wtapi=b;this._wtapi.registerHandler("message",this._handleMessage,this,10);this._wtapi.addListener("connected",this._onConnected,this);this._wtapi.addListener("disconnected",this._onDisconnected,this);a.Observable.call(this)}function c(a,b){var c=b,d;if(d=b.match(/^Wildix (WP\d+) ((\d+\.)+\d+).*?$/i))c=d[1];else if(d=b.match(/^Wildix (W-AIR) ((\d+\.)+\d+).*?$/i))c=d[1];else if(d=b.match(/^Wildix (Zero Distance) ((\d+\.)+\d+).*?$/i))c=
d[1];this.getId=function(){return a};this.getName=function(){return c};this.getUserAgent=function(){return b}}function d(a,b,c,d,h,m,p,n,l){this._calleeNumber=b;this._calleeName=c;this._duration=parseInt(d);this._durationTime=Math.round((new Date).getTime()/1E3);this._record=h;this._state=m;this._channel=a;this._destination=n;this._type=l;this._hangupCauseText=this._hangupCause=null;this.getDirection=function(){return p}}b.prototype=Object.create(a.Observable.prototype);b.prototype.call=function(a,
b,c,d){d=d||this;a=this._createOriginateUsingReferPacket(a,b);c=this._proxyIqCallback(c,d);this._wtapi.getConnection().sendIQ(a,c)};b.prototype.callToMobility=function(a,b,c,d,h){h=h||this;a=this._createOriginateUsingMobilityPacket(a,b,c);d=this._proxyIqCallback(d,h);this._wtapi.getConnection().sendIQ(a,d)};b.prototype.callToAllDevices=function(a,b,c){c=c||this;a=this._createOriginateUsingInvitePacket(a);b=this._proxyIqCallback(b,c);this._wtapi.getConnection().sendIQ(a,b)};b.prototype.answer=function(a,
b,c){var d=c||this;a=this._createAnswerCallPacket(b,a);c=this._proxyIqCallback(c,d);this._wtapi.getConnection().sendIQ(a,c)};b.prototype.hangup=function(a,b,c){c=c||this;a=this._createHangUpCallPacket(a);b=this._proxyIqCallback(b,c);this._wtapi.getConnection().sendIQ(a,b)};b.prototype.hold=function(a,b,c){c=c||this;a=this._createHoldPacket(a);b=this._proxyIqCallback(b,c);this._wtapi.getConnection().sendIQ(a,b)};b.prototype.resume=function(a,b,c){c=c||this;a=this._createResumePacket(a);b=this._proxyIqCallback(b,
c);this._wtapi.getConnection().sendIQ(a,b)};b.prototype.forward=function(a,b,c,d){d=d||this;a=this._createForwardPacket(a,b);c=this._proxyIqCallback(c,d);this._wtapi.getConnection().sendIQ(a,c)};b.prototype.bridge=function(a,b,c,d){d=d||this;a=this._createBridgePacket(a,b);c=this._proxyIqCallback(c,d);this._wtapi.getConnection().sendIQ(a,c)};b.prototype.startRecord=function(a,b,c){c=c||this;a=this._createStartRecordPacket(a);b=this._proxyIqCallback(b,c);this._wtapi.getConnection().sendIQ(a,b)};b.prototype.stopRecord=
function(a,b,c){c=c||this;a=this._createStopRecordPacket(a);b=this._proxyIqCallback(b,c);this._wtapi.getConnection().sendIQ(a,b)};b.prototype.getActiveCalls=function(){return this._calls.slice(0)};b.prototype.getRegisteredDevices=function(){return this._devices.slice(0)};b.prototype._onConnected=function(){};b.prototype._onDisconnected=function(){this._devices=[];this._fire("devices_changed",this._devices);for(var a=0;a<this._calls.length;a++)this._fire("call_terminated",this._calls[a]);this._calls=
[]};b.prototype._handleMessage=function(a){if(this._handleCallsStateMessage(a)||this._handleDevicesStateMessage(a))return!0};b.prototype._handleCallsStateMessage=function(a){a=a.getChild("event","urn:wildix:ami");if(null!==a){switch(a.getAttribute("type")){case "new":this._handleCallsAdded(this._parseCallItems(a));break;case "update":this._handleCallsUpdated(this._parseCallItems(a));break;case "remove":this._handleCallsRemoved(this._parseCallItems(a));break;case "state":this._handleCallsState(this._parseCallItems(a))}return!0}};
b.prototype._handleCallsAdded=function(a){for(var b=0;b<a.length;b++){for(var c=d.fromObject(a[b]),k=!1,h=0;h<this._calls.length;h++)if(this._calls[h].getChannel()==c.getChannel()){k=!0;break}k||(this._calls.push(c),this._fire("call_added",c))}};b.prototype._handleCallsUpdated=function(a){for(var b=0;b<a.length;b++)for(var c=a[b].channel,d=0;d<this._calls.length;d++){var h=this._calls[d];h.getChannel()===c&&(h.updateFromObject(a[b]),this._fire("call_updated",h))}};b.prototype._handleCallsRemoved=
function(a){for(var b=0;b<a.length;b++){for(var c=a[b].channel,d=[],h=0;h<this._calls.length;h++){var m=this._calls[h];m.getChannel()!==c?d.push(m):(m._hangupCause=a[b].hangupCause,m._hangupCauseText=a[b].hangupCauseText,this._fire("call_terminated",m))}this._calls=d}};b.prototype._handleCallsState=function(a){return this._handleCallsAdded(a)};b.prototype._handleDevicesStateMessage=function(a){a=a.getChild("event","urn:wildix:devices");if(null!==a){this._devices=[];a=a.getElementsByTagName("item");
for(var b=0;b<a.length;b++){var d=c.fromObject(this._parseDeviceItem(a.item(b)));this._devices.push(d)}this._fire("devices_changed",this._devices);return!0}};b.prototype._createOriginateUsingReferPacket=function(a,b){var c=new JSJaCIQ;c.setType("set");var d=c.setQuery("urn:wildix:ami"),h=c.getDoc().createElement("originate");h.setAttribute("to",b);h.setAttribute("device",a.getId());h.setAttribute("type","refer");d.appendChild(h);return c};b.prototype._createOriginateUsingInvitePacket=function(a){var b=
new JSJaCIQ;b.setType("set");var c=b.setQuery("urn:wildix:ami"),d=b.getDoc().createElement("originate");d.setAttribute("to",a);c.appendChild(d);return b};b.prototype._createOriginateUsingMobilityPacket=function(a,b,c){c||(c="en");var d=new JSJaCIQ;d.setType("set");var h=d.setQuery("urn:wildix:ami"),m=d.getDoc().createElement("originate");m.setAttribute("to",b);m.setAttribute("type","mobility");m.setAttribute("mobility",a);m.setAttribute("lang",c);h.appendChild(m);return d};b.prototype._createAnswerCallPacket=
function(a,b){var c=(new JSJaCIQ).setType("set"),d=c.setQuery("urn:wildix:ami"),h=c.getDoc().createElement("answer");h.setAttribute("channel",a.getChannel());h.setAttribute("device",b.getId());d.appendChild(h);return c};b.prototype._createHangUpCallPacket=function(a){var b=(new JSJaCIQ).setType("set"),c=b.setQuery("urn:wildix:ami"),d=b.getDoc().createElement("hangup");d.setAttribute("channel",a.getChannel());c.appendChild(d);return b};b.prototype._createDeclineCallPacket=function(a){var b=(new JSJaCIQ).setType("set"),
c=b.setQuery("urn:wildix:ami"),d=b.getDoc().createElement("hangup");d.setAttribute("channel",a.getChannel());c.appendChild(d);return b};b.prototype._createHoldPacket=function(a){var b=(new JSJaCIQ).setType("set"),c=b.setQuery("urn:wildix:ami"),d=b.getDoc().createElement("hold");d.setAttribute("channel",a.getChannel());c.appendChild(d);return b};b.prototype._createResumePacket=function(a){var b=(new JSJaCIQ).setType("set"),c=b.setQuery("urn:wildix:ami"),d=b.getDoc().createElement("unhold");d.setAttribute("channel",
a.getChannel());c.appendChild(d);return b};b.prototype._createStartRecordPacket=function(a){var b=(new JSJaCIQ).setType("set"),c=b.setQuery("urn:wildix:ami"),d=b.getDoc().createElement("record-start");d.setAttribute("channel",a.getChannel());c.appendChild(d);return b};b.prototype._createStopRecordPacket=function(a){var b=(new JSJaCIQ).setType("set"),c=b.setQuery("urn:wildix:ami"),d=b.getDoc().createElement("record-stop");d.setAttribute("channel",a.getChannel());c.appendChild(d);return b};b.prototype._createForwardPacket=
function(a,b){var c=(new JSJaCIQ).setType("set"),d=c.setQuery("urn:wildix:ami"),h=c.getDoc().createElement("forward");h.setAttribute("channel",a.getChannel());h.setAttribute("to",b);d.appendChild(h);return c};b.prototype._createBridgePacket=function(a,b){var c=(new JSJaCIQ).setType("set"),d=c.setQuery("urn:wildix:ami").appendChild(c.buildNode("bridge",{xmlns:"urn:wildix:ami"}));d.appendChild(c.buildNode("call",{xmlns:"urn:wildix:ami",channel:a.getChannel()}));d.appendChild(c.buildNode("call",{xmlns:"urn:wildix:ami",
channel:b.getChannel()}));return c};b.prototype._parseCallItems=function(a){a=a.getElementsByTagName("call");for(var b=[],c=0;c<a.length;c++)b.push(this._parseCallItem(a.item(c)));return b};b.prototype._parseCallItem=function(a){var b=a.querySelector("hangup-cause"),c=null,d=null;b&&(c=b.getAttribute("cause"),d=b.getAttribute("cause-txt"));return{channel:a.getAttribute("channel"),calleeNumber:a.getAttribute("connected_line_num"),calleeName:a.getAttribute("connected_line_name"),duration:a.getAttribute("duration"),
record:a.getAttribute("record"),state:a.getAttribute("state"),direction:a.getAttribute("direction"),destination:a.getAttribute("destination"),type:a.getAttribute("type"),hangupCause:c,hangupCauseText:d}};b.prototype._parseDeviceItem=function(a){return{id:a.getAttribute("id"),name:a.getAttribute("name")}};b.prototype._proxyIqCallback=function(a,b){return{error_handler:function(c){var d=c.getNode().getElementsByTagName("error");c="unknown";if(0<d.length&&(d=d[0].firstChild))c=d.tagName;a.call(b,c)},
result_handler:function(){a.call(b,null)}}};c.fromObject=function(a){return new c(a.id,a.name)};d.fromObject=function(a){return new d(a.channel,a.calleeNumber,a.calleeName,a.duration,a.record,a.state,a.direction,a.destination,a.type)};d.prototype.updateFromObject=function(a){this._calleeNumber=a.calleeNumber;this._calleeName=a.calleeName;this._duration=parseInt(a.duration);this._durationTime=Math.round((new Date).getTime()/1E3);this._record=a.record;this._state=a.state;this._destination=a.destination;
this._type=a.type;this._hangupCause=a.hangupCause;this._hangupCauseText=a.hangupCauseText};d.prototype.getChannel=function(){return this._channel};d.prototype.getDestinationChannel=function(){return this._destination};d.prototype.getType=function(){return this._type};d.prototype.getDuration=function(){var a=Math.round((new Date).getTime()/1E3)-this._durationTime;return this._duration+a};d.prototype.getFormattedDuration=function(){var a=this.getDuration();if(isNaN(a))return"00:00";var b=parseInt(a/
3600)%24,c=parseInt(a/60)%60,d="",a=a%60;0<b&&(d+=(10>b?"0"+b:b)+":");return d+((10>c?"0"+c:c)+":"+(10>a?"0"+a:a))};d.prototype.getCalleeName=function(){return this._calleeName};d.prototype.getCalleeNumber=function(){return this._calleeNumber};d.prototype.getFormattedCalleeName=function(){return 0<this._calleeName.length?this._calleeName+"("+this._calleeNumber+")":this._calleeNumber};d.prototype.getState=function(){return this._state};d.prototype.getFormattedState=function(){switch(this._state){case "ring":return"Ringing";
case "hold":return"Paused";case "up":return"Connected"}};d.prototype.isIncoming=function(){return"incoming"==this.getDirection()};d.prototype.isOutgoing=function(){return"outgoing"==this.getDirection()};d.prototype.isRecorded=function(){return"on"==this._record};d.prototype.getRecordedFiles=function(b,c){b=b||function(){};c=c||function(){};var d=this.getChannel();this.isIncoming()&&(d=this.getDestinationChannel());d&&""!=d&&a.ajax({url:"/api/v1/Calls/"+encodeURIComponent(d)+"/Recordings/",type:"GET",
success:function(a,c,d){"result"==a.type&&(a.result&&a.result.records)&&b(this,a.result.records)}.bind(this),error:function(a,b,d){if(404!=a.status){if(a&&a.responseText)try{var e=JSON.parse(a.responseText);e.type&&"error"==e.type&&c(this,e.reason)}catch(g){c(this,g.message)}}else c(this,a.statusText)}.bind(this)})};d.prototype.isRinging=function(){return"ring"==this._state};d.prototype.isOnHold=function(){return"hold"==this._state};d.prototype.getHangupCause=function(){return this._hangupCause};
d.prototype.getHangupCauseText=function(){return this._hangupCauseText};a.addPlugin("telephony",b)})(WTAPI);(function(a){function b(b){this._queues=[];this._subscribed=!1;this._wtapi=b;this._wtapi.registerHandler("message",this._handleMessage,this,10);this._wtapi.addListener("connected",this._onConnected,this);this._wtapi.addListener("disconnected",this._onDisconnected,this);this._messageHandlers=[this._handleMessageQueueAdd,this._handleMessageQueueRemove,this._handleMessageMemberAdd,this._handleMessageMemberUpdate,this._handleMessageMemberRemove,this._handleMessageMemberCallAdd,this._handleMessageMemberCallRemove,
this._handleMessageUserJoin,this._handleMessageUserLeave];a.Observable.call(this)}function c(a,b){this._members=[];this._users=[];this.getId=function(){return a};this.getName=function(){return b}}function d(a,b,c,d,e,f,l,u){this._location=a;this._extension=b;this._name=c;this._membership=d;this._penalty=e;this._status=f;this._pause=l;this._sleep=parseInt(u);this._sleepSetTime=Math.round((new Date).getTime()/1E3);this._calls=[]}function e(a,b,c,d){this._channel=a;this._num=b;this._name=c;this._duration=
parseInt(d);this._durationSetTime=Math.round((new Date).getTime()/1E3)}function f(a,b,c,d,e){this._channel=a;this._destinationChannel=b;this._calleeNumber=c;this._calleeName=d;this._duration=parseInt(e);this._durationSetTime=Math.round((new Date).getTime()/1E3)}b.prototype=Object.create(a.Observable.prototype);b.prototype.subscribe=function(a,b){if(!this._subscribed){this._subscribed=!0;var c=b||this,d=this,e=this._createSubscribePacket();this._wtapi.getConnection().sendIQ(e,{result_handler:function(b){d._handleSubscribeResponse(b,
a,c)}})}};b.prototype.isSubscribed=function(){return this._subscribed};b.prototype.unsubscribe=function(a,b){var c=b||this,d=this,e=this._createUnsubscribePacket();this._wtapi.getConnection().sendIQ(e,{result_handler:function(b){d._handleUnsubscribeResponse(b,a,c)}})};b.prototype.add=function(a,b,c,d){d=d||this;a=this._createAddPacket(a,b);c=this._createIqHandler(c,d);this._wtapi.getConnection().sendIQ(a,c)};b.prototype.remove=function(a,b,c,d){d=d||this;a=this._createRemovePacket(a,b);c=this._createIqHandler(c,
d);this._wtapi.getConnection().sendIQ(a,c)};b.prototype.pause=function(a,b,c,d){d=d||this;a=this._createPausePacket(a,b);c=this._createIqHandler(c,d);this._wtapi.getConnection().sendIQ(a,c)};b.prototype.resume=function(a,b,c,d){d=d||this;a=this._createResumePacket(a,b);c=this._createIqHandler(c,d);this._wtapi.getConnection().sendIQ(a,c)};b.prototype.getQueues=function(){return this._queues};b.prototype.getQueue=function(a){for(var b=0;b<this._queues.length;b++)if(this._queues[b].getId()==a)return this._queues[b];
return null};b.prototype._onConnected=function(){this._subscribed&&(this._subscribed=!1,this.subscribe())};b.prototype._onDisconnected=function(){for(var a=0;a<this._queues.length;a++)this._fire("queue_removed",this._queues[a]);this._queues=[]};b.prototype._handleMessage=function(a){a=a.getChild("event","urn:wildix:queues");if(null!==a)for(var b=a.getAttribute("operation"),c=0;c<this._messageHandlers.length;c++)if(this._messageHandlers[c].call(this,a,b))return!0;return!1};b.prototype._handleMessageQueueAdd=
function(a,b){if("add"!=b)return!1;var d=a.getElementsByTagName("queue");if(0==d.length)return!1;for(var e=0;e<d.length;e++){var f=d.item(e),n=f.getAttribute("id"),f=f.getAttribute("name"),l=this.getQueue(n);null===l&&(l=new c(n,f),this._queues.push(l),this._fire("queue_added",l))}return!0};b.prototype._handleMessageQueueRemove=function(a,b){if("remove"!=b)return!1;var c=a.getElementsByTagName("queue");if(0==c.length)return!1;for(var d=0;d<c.length;d++){var e=c.item(d).getAttribute("id"),e=this.getQueue(e);
if(null!==e)for(var f in this._queues)if(this._queues[f]==e){this._queues.splice(f,1);this._fire("queue_removed",e);break}}return!0};b.prototype._handleMessageMemberAdd=function(a,b){if("add"!=b)return!1;var c=a.getElementsByTagName("member");if(0==c.length)return!1;for(var e=0;e<c.length;e++){var f=c.item(e),f=this._parseMemberItem(f),n=this.getQueue(f.queue);if(n){var l=n.getMember(f.location);l||(l=d.fromObject(f),n._addMember(l),this._fire("member_added",n,l))}}return!0};b.prototype._handleMessageMemberUpdate=
function(a,b){if("update"!=b)return!1;var c=a.getElementsByTagName("member");if(0==c.length)return!1;for(var d=0;d<c.length;d++){var e=c.item(d),e=this._parseMemberItem(e),f=this.getQueue(e.queue);if(f){var l=f.getMember(e.location);l&&(l._updateFromObject(e),this._fire("member_updated",f,l))}}return!0};b.prototype._handleMessageMemberRemove=function(a,b){if("remove"!=b)return!1;var c=a.getElementsByTagName("member");if(0==c.length)return!1;for(var d=0;d<c.length;d++){var e=c.item(d),f=this._parseMemberItem(e);
if(e=this.getQueue(f.queue))if(f=e.getMember(f.location))e._removeMember(f),this._fire("member_removed",e,f)}return!0};b.prototype._handleMessageMemberCallAdd=function(a,b){if("add"!=b)return!1;var c=a.getElementsByTagName("call");if(0==c.length)return!1;for(var d=0;d<c.length;d++){var e=c.item(d),n=this._parseMemberCallItem(e);if(e=this.getQueue(n.queue)){var l=e.getMember(n.location);l&&(n=f.fromObject(n),l._addCall(n),this._fire("call_added",e,l,n))}}return!0};b.prototype._handleMessageMemberCallRemove=
function(a,b){if("remove"!=b)return!1;var c=a.getElementsByTagName("call");if(0==c.length)return!1;for(var d=0;d<c.length;d++){var e=c.item(d),f=this._parseMemberCallItem(e);if(e=this.getQueue(f.queue)){var l=e.getMember(f.location);if(l&&(f=l.getCall(f.channel)))l._removeCall(f),this._fire("call_removed",e,l,f)}}return!0};b.prototype._handleMessageUserJoin=function(a,b){if("join"!=b)return!1;var c=a.getElementsByTagName("user");if(0==c.length)return!1;for(var d=0;d<c.length;d++){var f=c.item(d),
f=this._parseUserItem(f),n=this.getQueue(f.queue);if(n){var l=n.getMember(f.channel);l||(l=e.fromObject(f),n._addUser(l),this._fire("user_join",n,l))}}return!0};b.prototype._handleMessageUserLeave=function(a,b){if("leave"!=b)return!1;var c=a.getElementsByTagName("user");if(0==c.length)return!1;for(var d=0;d<c.length;d++){var e=c.item(d),f=this._parseUserItem(e);if(e=this.getQueue(f.queue))if(f=e.getUser(f.channel))e._removeUser(f),this._fire("user_left",e,f)}return!0};b.prototype._handleSubscribeResponse=
function(a,b,c){this._queues=this._parseSubscribeResponse(a);for(a=0;a<this._queues.length;a++)this._fire("queue_added",this._queues[a]);"function"==typeof b&&b.call(c,this._queues)};b.prototype._handleUnsubscribeResponse=function(a,b,c){for(a=0;a<this._queues.length;a++)this._fire("queue_removed",this._queues[a]);this._queues=[];this._subscribed=!1;"function"==typeof b&&b.call(c)};b.prototype._createIqHandler=function(a,b){return{error_handler:function(c){var d=c.getNode().getElementsByTagName("error");
c="unknown";if(0<d.length&&(d=d[0].firstChild))c=d.tagName;a.call(b,c)},result_handler:function(){a.call(b,null)}}};b.prototype._createSubscribePacket=function(){var a=(new JSJaCIQ).setType("set"),b=a.setQuery("urn:wildix:queues"),c=a.getDoc().createElement("subscribe");b.appendChild(c);return a};b.prototype._createUnsubscribePacket=function(){var a=(new JSJaCIQ).setType("set"),b=a.setQuery("urn:wildix:queues"),c=a.getDoc().createElement("unsubscribe");b.appendChild(c);return a};b.prototype._createAddPacket=
function(a,b){var c=(new JSJaCIQ).setType("set"),d=c.setQuery("urn:wildix:queues"),e=c.getDoc().createElement("add");e.setAttribute("queue",a.getId());e.setAttribute("extension",b);d.appendChild(e);return c};b.prototype._createRemovePacket=function(a,b){var c=(new JSJaCIQ).setType("set"),d=c.setQuery("urn:wildix:queues"),e=c.getDoc().createElement("remove");e.setAttribute("queue",a.getId());e.setAttribute("location",b.getLocation());d.appendChild(e);return c};b.prototype._createPausePacket=function(a,
b){var c=(new JSJaCIQ).setType("set"),d=c.setQuery("urn:wildix:queues"),e=c.getDoc().createElement("pause");e.setAttribute("queue",a.getId());e.setAttribute("location",b.getLocation());d.appendChild(e);return c};b.prototype._createResumePacket=function(a,b){var c=(new JSJaCIQ).setType("set"),d=c.setQuery("urn:wildix:queues"),e=c.getDoc().createElement("unpause");e.setAttribute("queue",a.getId());e.setAttribute("location",b.getLocation());d.appendChild(e);return c};b.prototype._parseSubscribeResponse=
function(a){a=a.getChild("queues","urn:wildix:queues").getElementsByTagName("queue");for(var b=[],h=0;h<a.length;h++){for(var m=a.item(h),p=m.getAttribute("id"),n=m.getAttribute("name"),p=new c(p,n),l=m.getElementsByTagName("member"),m=m.getElementsByTagName("user"),n=0;n<l.length;n++){for(var u=l.item(n),q=d.fromObject(this._parseMemberItem(u)),u=u.getElementsByTagName("call"),s=0;s<u.length;s++){var v=f.fromObject(this._parseMemberCallItem(u[s]));q._addCall(v)}p._addMember(q)}for(n=0;n<m.length;n++)l=
m.item(n),l=e.fromObject(this._parseUserItem(l)),p._addUser(l);b.push(p)}return b};b.prototype._parseMemberItem=function(a){return{queue:a.getAttribute("queue"),location:a.getAttribute("location"),extension:a.getAttribute("extension"),name:a.getAttribute("name"),membership:a.getAttribute("membership"),penalty:a.getAttribute("penalty"),status:a.getAttribute("status"),pause:a.getAttribute("pause"),sleep:a.getAttribute("sleep")}};b.prototype._parseMemberCallItem=function(a){return{queue:a.getAttribute("queue"),
location:a.getAttribute("location"),channel:a.getAttribute("channel"),destination:a.getAttribute("destination"),calleeNumber:a.getAttribute("connected_line_num"),calleeName:a.getAttribute("connected_line_name"),duration:a.getAttribute("duration")}};b.prototype._parseUserItem=function(a){return{queue:a.getAttribute("queue"),channel:a.getAttribute("channel"),num:a.getAttribute("num"),name:a.getAttribute("name"),duration:a.getAttribute("duration")}};c.prototype.getId=function(){return this._id};c.prototype.getMember=
function(a){for(var b=0;b<this._members.length;b++)if(this._members[b].getLocation()==a)return this._members[b];return null};c.prototype.getMembers=function(){return this._members};c.prototype._addMember=function(a){this._members.push(a)};c.prototype._removeMember=function(a){for(var b in this._members)if(this._members[b]==a){this._members.splice(b,1);break}};c.prototype.getUser=function(a){for(var b=0;b<this._users.length;b++)if(this._users[b].getChannel()==a)return this._users[b];return null};c.prototype.getUsers=
function(){return this._users};c.prototype._addUser=function(a){this._users.push(a)};c.prototype._removeUser=function(a){for(var b in this._users)if(this._users[b]==a){this._users.splice(b,1);break}};d.fromObject=function(a){return new d(a.location,a.extension,a.name,a.membership,a.penalty,a.status,a.pause,a.sleep)};d.prototype.getLocation=function(){return this._location};d.prototype.getExtension=function(){return this._extension};d.prototype.getName=function(){return this._name};d.prototype.isStaticMember=
function(){return"static"==this._membership};d.prototype.isDynamicMember=function(){return"dynamic"==this._membership};d.prototype.getPenalty=function(){return this._penalty};d.prototype.getStatus=function(){return this._status};d.prototype.isPaused=function(){return"true"==this._pause};d.prototype.getSleepTime=function(){var a=Math.round((new Date).getTime()/1E3)-this._sleepSetTime;return this._sleep+a};d.prototype.getTalkTime=function(){return 0<this._calls.length?this._calls[0].getDuration():0};
d.prototype.getCall=function(a){for(var b=0;b<this._calls.length;b++)if(this._calls[b].getChannel()==a)return this._calls[b];return null};d.prototype.getCalls=function(){return this._calls};d.prototype._addCall=function(a){this._calls.push(a)};d.prototype._removeCall=function(a){for(var b in this._calls)if(this._calls[b]==a){this._calls.splice(b,1);break}0==this._calls.length&&(this._sleepSetTime=Math.round((new Date).getTime()/1E3))};d.prototype._updateFromObject=function(a){this._location=a.location;
this._extension=a.extension;this._membership=a.membership;this._penalty=a.penalty;this._status=a.status;this._pause=a.pause;this._sleep=parseInt(a.sleep);this._sleepSetTime=Math.round((new Date).getTime()/1E3)};e.fromObject=function(a){return new e(a.channel,a.num,a.name,a.duration)};e.prototype.getChannel=function(){return this._channel};e.prototype.getNumber=function(){return this._num};e.prototype.getName=function(){return this._name};e.prototype.getDuration=function(){var a=Math.round((new Date).getTime()/
1E3)-this._durationSetTime;return this._duration+a};f.fromObject=function(a){return new f(a.channel,a.destination,a.calleeNumber,a.calleeName,a.duration)};f.prototype.getChannel=function(){return this._channel};f.prototype.getDestinationChannel=function(){return this._destinationChannel};f.prototype.getCalleeNumber=function(){return this._calleeNumber};f.prototype.getCalleeName=function(){return this._calleeName};f.prototype.getDuration=function(){var a=Math.round((new Date).getTime()/1E3)-this._durationSetTime;
return this._duration+a};a.addPlugin("queues",b)})(WTAPI);(function(a){function b(b){this._wtapi=b;this._wtapi.registerHandler("message",this._handleMessage,this,100);this._roster=this._wtapi.roster;a.Observable.call(this)}b.prototype=Object.create(a.Observable.prototype);b.prototype.send=function(a,b){var e=new JSJaCMessage;e.setID(b.getId());e.setTo(a.getJid());e.setType("chat");e.setBody(b.getBody());this._wtapi.getConnection().send(e)};b.prototype.sendDeliveryConfirmation=function(a,b){var e=new JSJaCMessage;e.setTo(a.getJid());e.setType("chat");e.appendNode("received",
{xmlns:"urn:xmpp:receipts",id:b.getId()});this._wtapi.getConnection().send(e)};b.prototype._handleMessage=function(b){if(this._handleMessageDelivery(b))return!0;var d=b.getType(),e=b.getBody();if(!(""==d||"chat"==d||"normal"==d)||0==e.length)return!1;var d=b.getID(),f=new a.Message.Builder;f.withId(d);f.withBody(e);e=f.build();d=b.getChildVal("nick","http://jabber.org/protocol/nick");b=b.getFromJID().removeResource().toString();f=this._roster.getUser(b);null===f&&(""==d&&(d=null),f=this._roster.createUser(b,
d));this._fire("message_received",f,e)};b.prototype._handleMessageDelivery=function(a){var b=a.getNode().getElementsByTagName("received");1==b.length&&(b=b.item(0).getAttribute("id"),a=a.getFromJID().removeResource().toString(),a=this._roster.getUser(a),null!==a&&null!==b&&this._fire("message_received",a,b))};a.addPlugin("chat",b)})(WTAPI);(function(a){function b(b){this._presences={};this._subscriptions=[];this._wtapi=b;this._wtapi.registerHandler("iq",this._handleIQ,this,10);this._wtapi.registerHandler("presence",this._handlePresence,this,10);this._wtapi.addListener("connected",this._onConnected,this);this._wtapi.addListener("disconnected",this._onDisconnected,this);this._roster=this._wtapi.roster;this._personal_presence=this._empty_presence=new a.Presence;a.Observable.call(this)}b.prototype=Object.create(a.Observable.prototype);
b.prototype.getPersonalPresence=function(){return this._personal_presence};b.prototype.changePersonalPresence=function(b,d,e){if(!(b instanceof a.Presence))throw Error("Presence should be an instance of WTAPI.Presence");e=e||this;b=this._createSetPresencePacket(b);d=this._createSetPresenceHandler(d,e);this._wtapi.getConnection().sendIQ(b,d)};b.prototype.get=function(a){a=a.getJid();return a in this._presences?this._presences[a]:this._empty_presence};b.prototype.getSubscriptions=function(a,b){var e=
b||this,f=this._createGetSubscriptionsPacket(),e=this._createGetSubscriptionsHandler(a,e);this._wtapi.getConnection().sendIQ(f,e)};b.prototype.subscribe=function(a,b){for(var e=this._subscriptions.slice(0),f=0;f<a.length;f++){for(var g=a[f],k=!1,h=0;h<e.length;h++)if(e[h]==g){k=!0;break}k||e.push(g)}g=b||this;f=this._createSetSubscriptionsPacket(e);g=this._createSetSubscriptionsHandler(b,g);this._subscriptions=e;this._wtapi.getConnection().sendIQ(f,g)};b.prototype.unsubscribe=function(a,b){for(var e=
[],f=0;f<this._subscriptions.length;f++){for(var g=this._subscriptions[f],k=!1,h=0;h<a.length;h++)if(a[h]==g){k=!0;break}k||e.push(g)}g=b||this;f=this._createSetSubscriptionsPacket(e);g=this._createSetSubscriptionsHandler(b,g);this._subscriptions=e;this._wtapi.getConnection().sendIQ(f,g)};b.prototype._onConnected=function(){0<this._subscriptions.length&&this._wtapi.getConnection().sendIQ(this._createSetSubscriptionsPacket(this._subscriptions),this._createSetSubscriptionsHandler(function(){},this));
this._wtapi.getConnection().sendIQ(this._createGetPersonalPresencePacket(),this._createGetPersonalPresenceHandler())};b.prototype._onDisconnected=function(){for(var b in this._presences)if(this._presences[b]instanceof a.Presence){var d=this._roster.getUser(b);null!==d&&(this._presences[b]=this._empty_presence,this._fire("presence_changed",d,this._empty_presence))}this._presences={};this._personal_presence=this._empty_presence;this._fire("personal_presence_changed",this._personal_presence)};b.prototype._handleIQ=
function(a){return"urn:wildix:presence"==a.getQueryXMLNS()?(this._personal_presence=this._parsePersonalPresence(a.getNode()).build(),this._fire("personal_presence_changed",this._personal_presence),!0):!1};b.prototype._handlePresence=function(a){var b=a.getFromJID();b.getResource();var e=a.getNode();a=a.getChildVal("nick","http://jabber.org/protocol/nick");var b=b.removeResource().toString(),e=this._parsePresence(e).build(),f=this._roster.getUser(b);null===f&&(""==a&&(a=null),f=this._roster.createUser(b,
a));this._presences[f.getJid()]=e;this._fire("presence_changed",f,e)};b.prototype._createGetSubscriptionsPacket=function(){var a=(new JSJaCIQ).setType("get");a.setQuery("urn:wildix:subscriptions");return a};b.prototype._createGetPersonalPresencePacket=function(){var a=(new JSJaCIQ).setType("get");a.setQuery("urn:wildix:presence");return a};b.prototype._createGetSubscriptionsHandler=function(a,b){var e=this;return{result_handler:function(f){"function"==typeof a&&a.call(b,e._parseGetSubscriptionsResponse(f))},
error_handler:function(){"function"==typeof a&&a.call(b,[])}}};b.prototype._createGetPersonalPresenceHandler=function(){var a=this;return{result_handler:function(b){a._personal_presence=a._parsePersonalPresence(b.getNode()).build();a._fire("personal_presence_changed",a._personal_presence)},error_handler:function(){}}};b.prototype._createSetSubscriptionsPacket=function(a){for(var b=(new JSJaCIQ).setType("set"),e=b.setQuery("urn:wildix:subscriptions"),f=b.getDoc().createElement("subscriptions"),g=0;g<
a.length;g++){var k=b.getDoc().createElement("item");k.setAttribute("user",a[g]);f.appendChild(k)}e.appendChild(f);return b};b.prototype._createSetSubscriptionsHandler=function(a,b){var e=this;return{result_handler:function(f){"function"==typeof a&&a.call(b,e._parseGetSubscriptionsResponse(f))},error_handler:function(){"function"==typeof a&&a.call(b,[])}}};b.prototype._createSetPresencePacket=function(a){var b=(new JSJaCIQ).setType("set"),e=b.setQuery("urn:wildix:presence"),f=b.getDoc().createElement("extra");
a.isAway()||a.isDND()?e.appendChild(b.buildNode("show",{},a.isAway()?"away":"dnd")):a.isMUR()&&e.appendChild(b.buildNode("show",{},"mur"));a.isStatusMessageAvailable()&&e.appendChild(b.buildNode("status",{},a.getStatusMessage()));a.isStatusUntilAvailable()&&(a.isAway()||a.isDND())&&f.appendChild(b.buildNode("until",{},this._formatUntilDate(a.getStatusUntil())));if(a.isLocationAvailable()){var g=b.getDoc().createElement("location");g.appendChild(b.buildNode("lat",{},a.getLocation().getLat()));g.appendChild(b.buildNode("lng",
{},a.getLocation().getLng()));g.appendChild(b.buildNode("address",{},a.getLocation().getAddress()));f.appendChild(g)}0<f.childNodes.length&&e.appendChild(f);return b};b.prototype._createSetPresenceHandler=function(a,b){var e=this;return{result_handler:function(f){e._personal_presence=e._parsePersonalPresence(f.getNode()).build();e._fire("personal_presence_changed",e._personal_presence);"function"==typeof a&&a.call(b,e._personal_presence)},error_handler:function(){"function"==typeof a&&a.call(b,e._personal_presence)}}};
b.prototype._parsePresence=function(b){var d=new a.Presence.Builder;(!b.hasAttribute("type")||"unavailable"!=b.getAttribute("type"))&&d.setOnline();var e=b.getElementsByTagName("show");if(0<e.length&&e.item(0).firstChild)switch(e.item(0).firstChild.nodeValue){case "away":d.setAway();break;case "dnd":d.setDND();break;case "mur":d.setMUR()}e=b.getElementsByTagName("status");0<e.length&&e.item(0).firstChild&&d.setStatusMessage(e.item(0).firstChild.nodeValue);b=b.getElementsByTagName("extra");if(0<b.length){b=
b.item(0);e=b.getElementsByTagName("device-show");if(0<e.length&&e.item(0).firstChild)switch(e.item(0).firstChild.nodeValue){case "ringing":d.setRinging();break;case "talking":d.setTalking();break;case "rt":d.setRingingAndTalking();break;case "registered":d.setRegisteredDevice()}e=b.getElementsByTagName("until");0<e.length&&e.item(0).firstChild&&(e=this._parseUntilDate(e.item(0).firstChild.nodeValue),null!==e&&d.setStatusUntil(e));var f=b.getElementsByTagName("location");if(0<f.length){var f=f.item(0),
g,k,h,e=f.getElementsByTagName("lat"),m=f.getElementsByTagName("lng"),f=f.getElementsByTagName("address");0<e.length&&e.item(0).firstChild&&(g=e.item(0).firstChild.nodeValue);0<m.length&&m.item(0).firstChild&&(k=m.item(0).firstChild.nodeValue);0<f.length&&f.item(0).firstChild&&(h=f.item(0).firstChild.nodeValue);g&&(k&&h)&&d.setLocation(new a.Location(h,g,k))}g=b.getElementsByTagName("connected-info");if(0<g.length){g=g.item(0);var p,n;k=g.getElementsByTagName("connected-name");0<k.length&&k.item(0).firstChild&&
(p=k.item(0).firstChild.nodeValue);g=g.getElementsByTagName("connected-id");0<g.length&&g.item(0).firstChild&&(n=g.item(0).firstChild.nodeValue);(p||n)&&d.setConnectedCall(new a.ConnectedCall(p,n))}var l=b.getElementsByTagName("profile_data");if(0<l.length){l=l.item(0);p=n=b=g=k=h=e="";var m=l.getElementsByTagName("mail"),f=l.getElementsByTagName("auth_provider"),u=l.getElementsByTagName("profile_url"),q=l.getElementsByTagName("gender"),s=l.getElementsByTagName("language"),v=l.getElementsByTagName("parentHostUrl"),
l=l.getElementsByTagName("photo_url");0<m.length&&m.item(0).firstChild&&(p=m.item(0).firstChild.nodeValue);0<f.length&&f.item(0).firstChild&&(n=f.item(0).firstChild.nodeValue);0<u.length&&u.item(0).firstChild&&(b=u.item(0).firstChild.nodeValue);0<q.length&&q.item(0).firstChild&&(g=q.item(0).firstChild.nodeValue);0<s.length&&s.item(0).firstChild&&(k=s.item(0).firstChild.nodeValue);0<v.length&&v.item(0).firstChild&&(h=v.item(0).firstChild.nodeValue);0<l.length&&l.item(0).firstChild&&(e=l.item(0).firstChild.nodeValue);
d.setProfileData(new a.ProfileData(p,n,b,g,k,h,e))}}return d};b.prototype._parsePersonalPresence=function(a){return this._parsePresence(a).setOnline()};b.prototype._parseGetSubscriptionsResponse=function(a){var b=[];a=a.getNode().getElementsByTagName("subscriptions");if(1!=a.length)return b;a=a.item(0).getElementsByTagName("item");for(var e=0;e<a.length;e++){var f=a.item(e);if(f.hasAttribute("user")){var g=f.getAttribute("user"),f=g;this._wtapi.isNewServer()?1>=g.split("@").length&&(f=g+"@"+this._wtapi.server):
f=g+"@wildix";g=this._roster.getUser(f);null===g&&(g=this._roster.createUser(f));b.push(g)}}return b};b.prototype._parseUntilISODate=function(a){return(a=new Date(a))?a:null};b.prototype._parseUntilDate=function(a){var b=/(\d{1,2})\/(\d{1,2})\/(\d{4})\s(\d{1,2}):(\d{1,2})/.exec(a);if(null===b)return this._parseUntilISODate(a);a=parseInt(b[3]);var e=parseInt(b[2])-1,f=parseInt(b[1]),g=parseInt(b[4]),b=parseInt(b[5]);return new Date(Date.UTC(a,e,f,g,b,0))};b.prototype._formatUntilDate=function(a){function b(a){return 10>
a?"0"+a:a}return a.getUTCFullYear()+"-"+b(a.getUTCMonth()+1)+"-"+b(a.getUTCDate())+"T"+b(a.getUTCHours())+":"+b(a.getUTCMinutes())+":"+b(a.getUTCSeconds())+"Z"};a.addPlugin("presence",b)})(WTAPI);
